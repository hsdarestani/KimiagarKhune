<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کیمیاگر خونه - داشبورد جامع</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc; /* gray-50 */
            overflow-y: hidden; /* Prevent vertical scroll on body */
        }
        .calendar-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            height: calc(100vh - 70px); /* Adjust based on header height */
        }
        .calendar-grid {
            display: grid;
            /* Mobile-first: fixed column width to enable horizontal scroll */
            grid-template-columns: repeat(7, 280px);
            gap: 1rem;
            min-height: calc(100vh - 140px);
        }
        /* On desktop (lg screens and up), columns become flexible and fill the space */
        @media (min-width: 1024px) {
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
        }
        .day-column {
            background-color: #f1f5f9; /* gray-100 */
            border-radius: 0.75rem;
            height: 100%;
            overflow-y: auto;
        }
        .view-switcher-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        /* Custom scrollbar */
        .day-column::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .modal-body::-webkit-scrollbar, #admin-panel-content::-webkit-scrollbar, .calendar-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .day-column::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb, #admin-panel-content::-webkit-scrollbar-thumb, .calendar-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        /* Card Hover Animation */
        .course-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .course-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Modal Animation */
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .admin-menu-item.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="w-full h-screen">

    <!-- Header -->
    <header class="bg-white shadow-md p-3 flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-rocket text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-extrabold text-gray-800">کیمیاگر خونه</h1>
        </div>
        <div class="flex items-center gap-4">
            <!-- Admin Specific Controls -->
            <div id="admin-controls" class="hidden items-center gap-4">
                <button id="open-admin-panel-btn" class="flex items-center gap-2 px-3 py-2 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-900">
                    <i class="fas fa-shield-halved"></i>
                    <span>پنل مدیریت</span>
                </button>
                <div class="items-center gap-2 hidden sm:flex">
                     <label for="counselor-filter" class="text-sm text-gray-600">فیلتر مشاور:</label>
                     <select id="counselor-filter" class="rounded-md border-gray-300 shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                         <option value="all">همه</option>
                         <option value="1">حسین دارستانی</option>
                         <option value="2">مریم رضایی</option>
                     </select>
                </div>
            </div>
             <!-- Student Specific Controls -->
            <div id="student-controls" class="hidden items-center gap-4">
                <button id="open-payment-modal-btn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                    <i class="fas fa-dollar-sign"></i>
                    <span>امور مالی</span>
                </button>
            </div>
             <!-- View Switcher -->
            <div class="flex rounded-md shadow-sm">
                <button id="adminBtn" class="px-3 py-2 border border-gray-300 rounded-r-lg text-sm focus:outline-none">ادمین</button>
                <button id="counselorBtn" class="px-3 py-2 border border-gray-300 text-sm focus:outline-none">مشاور</button>
                <button id="studentBtn" class="px-3 py-2 border border-gray-300 rounded-l-lg text-sm focus:outline-none">دانش‌آموز</button>
            </div>
            <!-- Profile Dropdown -->
            <div class="relative" id="profile-menu-container">
                <button id="profile-menu-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 border-indigo-300 hover:border-indigo-500 transition-all">
                    <img id="profile-img" src="https://placehold.co/40x40/c7d2fe/312e81?text=U" alt="پروفایل">
                </button>
                <div id="profile-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30">
                    <a href="#" id="open-profile-modal-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ویرایش پروفایل</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content: Calendar -->
    <main class="p-4 calendar-container">
        <div id="calendar-grid" class="calendar-grid">
            <!-- Calendar columns will be injected here by JS -->
        </div>
    </main>

    <!-- Floating Chat Button -->
    <button id="chat-toggle-btn" class="fixed bottom-6 left-6 w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-full shadow-lg text-white flex items-center justify-center z-30 transition-transform hover:scale-110">
        <i class="fas fa-comments fa-2x"></i>
        <span id="chat-notification-dot" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden"></span>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden fixed bottom-24 left-6 w-96 max-w-[90vw] h-[500px] bg-white rounded-xl shadow-2xl z-30 flex flex-col transition-all duration-300">
        <div id="chat-header" class="p-3 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-t-xl flex items-center justify-between">
            <h3 id="chat-title" class="font-bold">چت‌ها</h3>
            <button id="back-to-chats-btn" class="hidden"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div id="chat-body" class="flex-1 overflow-hidden flex flex-col">
             <div id="chat-list" class="h-full overflow-y-auto"></div>
             <div id="chat-messages-view" class="h-full flex-col hidden">
                 <div class="chat-messages flex-1 p-3 space-y-4 overflow-y-auto"></div>
                 <div class="p-2 border-t bg-gray-50 flex items-center gap-2">
                     <div class="flex-1 relative">
                        <input type="text" class="w-full p-2 border rounded-full pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="پیام...">
                        <button class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-indigo-600"><i class="fas fa-smile"></i></button>
                     </div>
                     <button class="text-gray-500 hover:text-indigo-600 p-2"><i class="fas fa-paperclip"></i></button>
                     <button class="text-gray-500 hover:text-indigo-600 p-2"><i class="fas fa-microphone"></i></button>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-md modal-enter">
            <h2 class="text-xl font-bold mb-4">ویرایش پروفایل</h2>
            <div class="flex flex-col items-center">
                <img id="modal-profile-img" src="https://placehold.co/100x100/c7d2fe/312e81?text=U" class="w-24 h-24 rounded-full mb-4 ring-4 ring-indigo-200">
                <input type="file" id="profile-img-upload" class="text-sm">
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button data-close-modal="profile-modal" class="px-4 py-2 bg-gray-200 rounded-lg">انصراف</button>
                <button id="save-profile-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ذخیره</button>
            </div>
        </div>
    </div>
    <!-- Course Details Modal -->
    <div id="course-details-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div id="course-details-content" class="bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl flex flex-col modal-enter"></div>
    </div>
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-5xl flex h-[80vh] modal-enter">
            <div class="w-1/4 bg-gray-800 text-white rounded-r-xl p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-6">پنل مدیریت</h2>
                <nav id="admin-menu" class="flex flex-col gap-2">
                    <button data-view="add-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 active">
                        <i class="fas fa-user-plus w-5"></i><span>افزودن دانش‌آموز</span>
                    </button>
                    <button data-view="assign-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-calendar-check w-5"></i><span>تخصیص دانش‌آموز</span>
                    </button>
                    <button data-view="send-notification" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-paper-plane w-5"></i><span>ارسال نوتیفیکیشن</span>
                    </button>
                    <button data-view="reports" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-chart-line w-5"></i><span>گزارش‌ها</span>
                    </button>
                     <button data-view="financials" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-dollar-sign w-5"></i><span>امور مالی</span>
                    </button>
                </nav>
                 <button data-close-modal="admin-panel-modal" class="mt-auto text-center p-3 bg-red-600 hover:bg-red-700 rounded-lg">بستن پنل</button>
            </div>
            <div id="admin-panel-content" class="w-3/4 p-6 overflow-y-auto"></div>
         </div>
    </div>
     <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-lg modal-enter">
            <h2 class="text-xl font-bold mb-4">ثبت اطلاعات پرداخت</h2>
             <p class="text-sm text-gray-600 mb-4">پس از واریز مبلغ دوره، لطفا اطلاعات زیر را برای تایید توسط ادمین تکمیل و ارسال نمایید.</p>
            <form class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">مبلغ واریز شده (تومان)</label><input type="number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">شماره پیگیری / ارجاع</label><input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">تاریخ واریز</label><input type="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="text-left pt-4">
                    <button type="button" data-close-modal="payment-modal" class="px-4 py-2 bg-gray-200 rounded-lg">انصراف</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ارسال برای تایید</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
// --- Helper Functions ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- Data Fetching ---
async function getAdminData() {
    try {
        const response = await fetch('/api/admin-panel-data/');
        if (!response.ok) throw new Error('Failed to fetch admin data');
        return await response.json();
    } catch (error) {
        console.error('Error fetching admin data:', error);
        alert('خطا در دریافت اطلاعات از سرور.');
        return null;
    }
}

// --- RENDER ADMIN VIEW (The Core Logic) ---
// این تابع را جایگزین تابع renderAdminView قبلی خود کنید یا آن را ویرایش کنید
const renderAdminView = async (viewName) => {
    const adminPanelContent = document.getElementById('admin-panel-content');
    document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`#admin-menu .admin-menu-item[data-view="${viewName}"]`).classList.add('active');
    
    adminPanelContent.innerHTML = '<div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;"></div>'; // Show loader

    const data = await getAdminData();
    if (!data) {
        adminPanelContent.innerHTML = '<p class="text-red-500">امکان بارگذاری اطلاعات وجود ندارد.</p>';
        return;
    }

    let content = '';
    switch(viewName) {
        case 'add-student':
            const gradeOptions = data.grades.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            const majorOptions = data.majors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            content = `
                <h3 class="text-xl font-bold mb-4">فرم افزودن دانش‌آموز جدید</h3>
                <form id="add-student-form" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">نام</label><input name="first_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">نام خانوادگی</label><input name="last_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">شماره موبایل</label><input name="phone_number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">پایه تحصیلی</label><select name="grade_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${gradeOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">رشته</label><select name="major_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${majorOptions}</select></div>
                    <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">افزودن</button></div>
                </form>`;
            break;

        case 'assign-student':
            const studentOptions = data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const advisorOptions = data.advisors.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            const dayOptions = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'].map(d => `<option value="${d}">${d}</option>`).join('');
            content = `
                <h3 class="text-xl font-bold mb-4">تخصیص دانش‌آموز به مشاور</h3>
                <form id="assign-student-form" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">انتخاب دانش‌آموز</label><select name="student_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${studentOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">انتخاب مشاور</label><select name="advisor_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${advisorOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">روز جلسه</label><select name="day_of_week" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${dayOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">تاریخ اولین جلسه</label><input name="start_date" type="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">ساعت جلسه</label><input name="start_time" type="time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">تخصیص</button></div>
                </form>`;
            break;
    }
    adminPanelContent.innerHTML = content;
    
    document.getElementById('add-student-form')?.addEventListener('submit', handleAddStudent);
    document.getElementById('assign-student-form')?.addEventListener('submit', handleAssignStudent);
};

// --- Form Handlers ---
async function handleAddStudent(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/add-student/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data),
        });
        const result = await response.json();
        if (response.status === 201) {
            alert(result.message);
            renderAdminView('assign-student'); // Refresh and switch to assign view
        } else {
            alert(`خطا: ${result.message || 'اطلاعات نامعتبر است.'}`);
        }
    } catch (error) {
        alert('یک خطای شبکه رخ داد.');
    }
}

async function handleAssignStudent(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());

    const dayOfWeekMapping = {
        'شنبه': 'Saturday', 'یکشنبه': 'Sunday', 'دوشنبه': 'Monday',
        'سه‌شنبه': 'Tuesday', 'چهارشنبه': 'Wednesday', 'پنج‌شنبه': 'Thursday', 'جمعه': 'Friday'
    };
    data.day_of_week = dayOfWeekMapping[data.day_of_week];

    try {
        const response = await fetch('/api/assign-student/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data),
        });
        const result = await response.json();
        if (response.status === 201) {
            alert(result.message);
            if (typeof renderCalendar === 'function') {
                 renderCalendar(); // تقویم اصلی را برای نمایش دوره جدید رفرش کنید
            }
            document.getElementById('admin-panel-modal').classList.add('hidden'); // بستن مودال
        } else {
            alert(`خطا: ${result.message || 'اطلاعات نامعتبر است.'}`);
        }
    } catch (error) {
        alert('یک خطای شبکه رخ داد.');
    }
}

// --- Initial Event Listeners ---
// این شنونده‌ها را به کدهای قبلی خود اضافه کنید یا جایگزین کنید
document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => {
    item.addEventListener('click', () => renderAdminView(item.dataset.view));
});

document.getElementById('open-admin-panel-btn').addEventListener('click', () => {
    renderAdminView('add-student'); // با این ویو به صورت پیش‌فرض باز شود
    document.getElementById('admin-panel-modal').classList.remove('hidden');
});

            // --- MOCK DATA ---
            const MOCK_DATA = {
                courses: [
                    { id: 1, studentId: 101, studentName: 'علی احمدی', counselorId: 1, counselorName: 'حسین دارستانی', dayOfWeek: 'شنبه', time: '09:00',
                    sessions: [{date: '1404/04/01', completed: true}, {date: '1404/04/08', completed: false}, {date: '1404/04/15', completed: false}, {date: '1404/04/22', completed: false}],
                    comments: [{author: 'حسین دارستانی', text: 'هفته اول عالی بود، ادامه بده.'}],
                    attachments: [{name: 'برنامه_هفتگی.pdf', url: '#'}, {name: 'جزوه_تکمیلی.docx', url: '#'}]
                    },
                    { id: 2, studentId: 102, studentName: 'زهرا محمدی', counselorId: 2, counselorName: 'مریم رضایی', dayOfWeek: 'دوشنبه', time: '16:00', 
                    sessions: [{date: '1404/04/03', completed: true}, {date: '1404/04/10', completed: true}, {date: '1404/04/17', completed: false}, {date: '1404/04/24', completed: false}],
                    comments: [],
                    attachments: []
                    },
                    { id: 3, studentId: 103, studentName: 'رضا اکبری', counselorId: 1, counselorName: 'حسین دارستانی', dayOfWeek: 'سه‌شنبه', time: '10:00',
                    sessions: [{date: '1404/04/04', completed: false}, {date: '1404/04/11', completed: false}, {date: '1404/04/18', completed: false}, {date: '1404/04/25', completed: false}],
                    comments: [{author: 'حسین دارستانی', text: 'لطفا گزارش کار رو کامل کن.'}],
                    attachments: [{name: 'فایل_صوتی_جلسه.mp3', url: '#'}]
                    }
                ],
                chats: {
                    '101': { otherPartyName: 'علی احمدی', messages: [{sender: 'me', text: 'سلام علی جان، برنامه رو دیدی؟'}, {sender: 'other', text: 'سلام استاد، بله. ممنونم'}] },
                    '103': { otherPartyName: 'رضا اکبری', messages: [{sender: 'other', text: 'استاد من فردا نمیرسم تمرین حل کنم.'}] }
                },
                 payments: [
                    { id: 1, studentName: 'علی احمدی', amount: 450000, refNumber: '123456789', date: '1404/04/01', status: 'approved' },
                    { id: 2, studentName: 'زهرا محمدی', amount: 450000, refNumber: '987654321', date: '1404/04/03', status: 'pending' },
                    { id: 3, studentName: 'رضا اکبری', amount: 450000, refNumber: '112233445', date: '1404/04/04', status: 'rejected' },
                ],
                users: {
                    admin: { id: 99, name: 'ادمین سیستم' },
                    counselor: { id: 1, name: 'حسین دارستانی' },
                    student: { id: 101, name: 'علی احمدی', counselorId: 1, counselorName: 'حسین دارستانی' }
                }
            };
            const daysOfWeek = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'];
            let currentRole = 'admin';
            
            // --- DOM Elements ---
            const calendarGrid = document.getElementById('calendar-grid');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const adminControls = document.getElementById('admin-controls');
            const studentControls = document.getElementById('student-controls');
            const counselorFilter = document.getElementById('counselor-filter');
            const adminPanelContent = document.getElementById('admin-panel-content');
            const chatWindow = document.getElementById('chat-window');
            const chatList = document.getElementById('chat-list');
            const chatMessagesView = document.getElementById('chat-messages-view');
            const chatMessagesContainer = chatMessagesView.querySelector('.chat-messages');
            const chatTitle = document.getElementById('chat-title');
            const backToChatsBtn = document.getElementById('back-to-chats-btn');
            const chatNotificationDot = document.getElementById('chat-notification-dot');

            // --- ALL FUNCTIONS DEFINED FIRST TO AVOID REFERENCE ERRORS ---

            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modalBackdrop.classList.remove('hidden');
                    modal.classList.remove('hidden');
                }
            };

            const closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    const content = modal.querySelector('.modal-enter');
                    if (content) content.classList.replace('modal-enter', 'modal-leave');
                    setTimeout(() => {
                        modalBackdrop.classList.add('hidden');
                        modal.classList.add('hidden');
                        if (content) content.classList.replace('modal-leave', 'modal-enter');
                    }, 300);
                }
            };
            
            const openCourseDetailsModal = (course) => {
                const modalContentContainer = document.getElementById('course-details-content');
                const weeklyPlanButton = (currentRole !== 'student') ? `
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                        <i class="fas fa-calendar-week"></i>
                        <span>برنامه هفتگی</span>
                    </button>
                ` : '';

                const sessionsHtml = course.sessions.map((session, index) => `
                    <li class="flex items-center justify-between text-sm py-2 border-b border-gray-100">
                        <label class="flex items-center gap-3 text-gray-700">
                            <input type="checkbox" ${session.completed ? 'checked' : ''} ${currentRole === 'student' ? 'disabled' : ''} class="w-5 h-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            جلسه ${index + 1}
                        </label>
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${session.date}</span>
                    </li>`).join('');
                
                const commentsHtml = course.comments.map(comment => `
                    <div class="bg-gray-50 p-3 rounded-lg mt-2">
                        <p class="font-semibold text-sm text-gray-800">${comment.author}:</p>
                        <p class="text-gray-600 text-sm">${comment.text}</p>
                    </div>`).join('');

                const attachmentsHtml = course.attachments.length > 0 ? course.attachments.map(file => `
                    <a href="${file.url}" target="_blank" class="flex items-center gap-2 text-sm text-indigo-600 hover:underline p-2 rounded-lg hover:bg-indigo-50">
                        <i class="fas ${file.name.includes('skyroom') ? 'fa-video' : 'fa-link'}"></i> ${file.name}
                    </a>`).join('') : '<p class="text-xs text-gray-400 p-2">فایلی ضمیمه نشده.</p>';

                modalContentContainer.innerHTML = `
                    <div class="p-5 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-t-xl border-b flex justify-between items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-extrabold text-gray-800">${course.studentName}</h2>
                            <p class="text-gray-500">دوره مشاوره - ${course.dayOfWeek} ساعت ${course.time}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            ${weeklyPlanButton}
                            <a href="#" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 flex items-center gap-2">
                                <i class="fas fa-video"></i>
                                <span>ورود به کلاس</span>
                            </a>
                        </div>
                    </div>
                    <div class="p-5 modal-body overflow-y-auto max-h-[60vh]">
                        <div class="mb-5">
                            <h3 class="font-bold mb-2">جلسات دوره</h3>
                            <ul class="space-y-1">${sessionsHtml}</ul>
                        </div>
                        <div class="mb-5">
                            <h3 class="font-bold mb-2">ضمیمه‌ها</h3>
                            <div class="space-y-1">${attachmentsHtml}</div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">نظرات</h3>
                            <div class="space-y-2">${commentsHtml || '<p class="text-xs text-gray-400">نظری ثبت نشده.</p>'}</div>
                            <div class="mt-4 flex items-center gap-2 p-2 border rounded-lg bg-white">
                                <input type="text" placeholder="نظر جدید..." class="flex-1 text-sm bg-transparent focus:outline-none">
                                <button class="text-gray-400 hover:text-indigo-600"><i class="fas fa-smile"></i></button>
                                <button class="text-gray-400 hover:text-indigo-600"><i class="fas fa-paperclip"></i></button>
                                <button class="text-gray-400 hover:text-indigo-600"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                    </div>
                     <div class="p-3 bg-gray-50 rounded-b-xl border-t flex justify-end gap-3">
                         <button data-close-modal="course-details-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">بستن</button>
                         <button data-close-modal="course-details-modal" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ذخیره تغییرات</button>
                    </div>
                `;
                openModal('course-details-modal');
            };
            
            const createCourseCard = (course) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm mb-3 course-card cursor-pointer';
                const completedSessions = course.sessions.filter(s => s.completed).length;
                const progressPercentage = (completedSessions / 4) * 100;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${course.studentName}</p>
                            <p class="text-sm text-indigo-600 font-semibold">${course.time}</p>
                        </div>
                        <div class="text-gray-400 text-lg hover:text-indigo-600">
                            <i class="fa-solid fa-square-arrow-up-right"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-gray-500 mb-1">پیشرفت دوره (${completedSessions} از 4)</p>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openCourseDetailsModal(course));
                return card;
            };

            const renderCalendar = () => {
                calendarGrid.innerHTML = "";
                let filteredCourses = MOCK_DATA.courses;
                if (currentRole === 'counselor') {
                    filteredCourses = MOCK_DATA.courses.filter(c => c.counselorId === MOCK_DATA.users.counselor.id);
                } else if (currentRole === 'student') {
                    filteredCourses = MOCK_DATA.courses.filter(c => c.studentId === MOCK_DATA.users.student.id);
                } else if (currentRole === 'admin' && counselorFilter.value !== 'all') {
                    filteredCourses = MOCK_DATA.courses.filter(c => c.counselorId == counselorFilter.value);
                }
                
                daysOfWeek.forEach(day => {
                    const column = document.createElement('div');
                    column.className = 'day-column p-2';
                    column.innerHTML = `<h3 class="font-extrabold text-center p-2 text-gray-700">${day}</h3>`;
                    filteredCourses.filter(c => c.dayOfWeek === day).forEach(course => column.appendChild(createCourseCard(course)));
                    calendarGrid.appendChild(column);
                });
            };

          

            const switchRole = (role, buttonElement) => {
                currentRole = role;
                document.querySelectorAll('.view-switcher-active').forEach(b => b.classList.remove('view-switcher-active'));
                buttonElement.classList.add('view-switcher-active');
                adminControls.classList.toggle('hidden', role !== 'admin');
                adminControls.classList.toggle('flex', role === 'admin');
                studentControls.classList.toggle('hidden', role !== 'student');
                studentControls.classList.toggle('flex', role === 'student');
                chatWindow.classList.add('hidden');
                renderCalendar();
            };

            const renderMessages = (chatId, otherPartyName) => {
                chatMessagesContainer.innerHTML = '';
                chatList.classList.add('hidden');
                chatMessagesView.style.display = 'flex';
                backToChatsBtn.classList.remove('hidden');
                chatTitle.textContent = otherPartyName;
                const chat = (currentRole === 'student') ? { messages: MOCK_DATA.chats[MOCK_DATA.users.student.id]?.messages || [] } : MOCK_DATA.chats[chatId];
                if (chat.messages) {
                    chat.messages.forEach(msg => {
                        const msgBubble = document.createElement('div');
                        const isMe = (currentRole === 'student' && msg.sender === 'other') || (currentRole !== 'student' && msg.sender === 'me');
                        msgBubble.className = `max-w-xs p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white self-end' : 'bg-gray-200 text-gray-800 self-start'}`;
                        msgBubble.textContent = msg.text;
                        chatMessagesContainer.appendChild(msgBubble);
                    });
                }
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            };

            const renderChatList = () => {
                chatList.innerHTML = '';
                chatMessagesView.classList.add('hidden');
                chatList.classList.remove('hidden');
                backToChatsBtn.classList.add('hidden');
                chatTitle.textContent = 'چت‌ها';
                chatNotificationDot.classList.remove('hidden');
                let chatsToShow = {};
                if (currentRole === 'student') {
                    const student = MOCK_DATA.users.student;
                    chatsToShow[student.counselorId] = { otherPartyName: student.counselorName, messages: MOCK_DATA.chats[student.id]?.messages || [] };
                } else { 
                    chatsToShow = MOCK_DATA.chats;
                }
                Object.entries(chatsToShow).forEach(([id, chat]) => {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    const listItem = document.createElement('div');
                    listItem.className = 'p-3 flex items-center gap-3 hover:bg-gray-100 cursor-pointer border-b';
                    listItem.innerHTML = `<img src="https://placehold.co/40x40/e0e7ff/4338ca?text=${chat.otherPartyName.charAt(0)}" class="w-10 h-10 rounded-full"><div><p class="font-bold">${chat.otherPartyName}</p><p class="text-sm text-gray-500 truncate">${lastMessage ? lastMessage.text : 'بدون پیام'}</p></div>`;
                    listItem.addEventListener('click', () => renderMessages(id, chat.otherPartyName));
                    chatList.appendChild(listItem);
                });
            };

            // --- SETUP LISTENERS ---
            document.getElementById('adminBtn').addEventListener('click', e => switchRole('admin', e.target));
            document.getElementById('counselorBtn').addEventListener('click', e => switchRole('counselor', e.target));
            document.getElementById('studentBtn').addEventListener('click', e => switchRole('student', e.target));
            counselorFilter.addEventListener('change', renderCalendar);
            document.getElementById('open-admin-panel-btn').addEventListener('click', () => {
                renderAdminView('add-student');
                openModal('admin-panel-modal');
            });
            document.getElementById('open-payment-modal-btn').addEventListener('click', () => openModal('payment-modal'));
            document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => {
                item.addEventListener('click', () => renderAdminView(item.dataset.view));
            });
            document.getElementById('chat-toggle-btn').addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if(!chatWindow.classList.contains('hidden')) renderChatList();
            });
            document.getElementById('back-to-chats-btn').addEventListener('click', () => renderChatList());
            const profileModalEl = document.getElementById("profile-modal"), modalImg = document.getElementById("modal-profile-img"), uploadInput = document.getElementById("profile-img-upload");
            document.getElementById('profile-menu-btn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('profile-dropdown').classList.toggle('hidden'); });
            document.body.addEventListener('click', () => document.getElementById('profile-dropdown').classList.add('hidden'));
            document.getElementById('open-profile-modal-btn').addEventListener('click', () => openModal('profile-modal'));
            document.getElementById("save-profile-btn").addEventListener("click", () => {
                if(uploadInput.files && uploadInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => { document.getElementById("profile-img").src = e.target.result; modalImg.src = e.target.result; };
                    reader.readAsDataURL(uploadInput.files[0]);
                }
                closeModal("profile-modal");
            });
            uploadInput.addEventListener("change", function() { if(this.files && this.files[0]) { const reader = new FileReader(); reader.onload = e => modalImg.src = e.target.result; reader.readAsDataURL(this.files[0]); } });
            
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    document.querySelectorAll('[id$="-modal"].modal-enter').forEach(modal => {
                        if (!modal.classList.contains('hidden')) {
                            closeModal(modal.id);
                        }
                    });
                }
            });
            
            document.body.addEventListener('click', e => { const closeButton = e.target.closest('[data-close-modal]'); if (closeButton) { closeModal(closeButton.dataset.closeModal); } });
            
            // --- INITIALIZATION ---
            if (MOCK_DATA.courses[0] && MOCK_DATA.courses[0].attachments) { MOCK_DATA.courses[0].attachments.push({name: 'لینک اسکای‌روم', url: 'https://skyroom.online/ch/example/class-101'}); }
            switchRole('admin', document.getElementById('adminBtn'));
        });
    </script>
</body>
</html>
