<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کیمیاگر خونه - داشبورد جامع</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc; /* gray-50 */
            overflow-y: hidden; /* Prevent vertical scroll on body */
        }
        .calendar-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            height: calc(100vh - 70px); /* Adjust based on header height */
        }
        .calendar-grid {
            display: grid;
            /* Mobile-first: fixed column width to enable horizontal scroll */
            grid-template-columns: repeat(7, 280px);
            gap: 1rem;
            min-height: calc(100vh - 140px);
        }
        /* On desktop (lg screens and up), columns become flexible and fill the space */
        @media (min-width: 1024px) {
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
        }
        .day-column {
            background-color: #f1f5f9; /* gray-100 */
            border-radius: 0.75rem;
            height: 100%;
            overflow-y: auto;
        }
        .view-switcher-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        /* Custom scrollbar */
        .day-column::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .modal-body::-webkit-scrollbar, #admin-panel-content::-webkit-scrollbar, .calendar-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .day-column::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb, #admin-panel-content::-webkit-scrollbar-thumb, .calendar-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        /* Card Hover Animation */
        .course-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .course-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Modal Animation */
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .admin-menu-item.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="w-full h-screen">

    <!-- Header -->
    <header class="bg-white shadow-md p-3 flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-rocket text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-extrabold text-gray-800">کیمیاگر خونه</h1>
        </div>
        <div class="flex items-center gap-4">
            <!-- Admin Specific Controls -->
            <div id="admin-controls" class="hidden items-center gap-4">
                <button id="open-admin-panel-btn" class="flex items-center gap-2 px-3 py-2 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-900">
                    <i class="fas fa-shield-halved"></i>
                    <span>پنل مدیریت</span>
                </button>
                <div class="items-center gap-2 hidden sm:flex">
                     <label for="counselor-filter" class="text-sm text-gray-600">فیلتر مشاور:</label>
                     <select id="counselor-filter" class="rounded-md border-gray-300 shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                         <option value="all">همه</option>
                         <option value="1">حسین دارستانی</option>
                         <option value="2">مریم رضایی</option>
                     </select>
                </div>
            </div>
             <!-- Student Specific Controls -->
            <div id="student-controls" class="hidden items-center gap-4">
                <button id="open-payment-modal-btn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                    <i class="fas fa-dollar-sign"></i>
                    <span>امور مالی</span>
                </button>
            </div>
             <!-- View Switcher -->
            <div class="flex rounded-md shadow-sm">
                <button id="adminBtn" class="px-3 py-2 border border-gray-300 rounded-r-lg text-sm focus:outline-none">ادمین</button>
                <button id="counselorBtn" class="px-3 py-2 border border-gray-300 text-sm focus:outline-none">مشاور</button>
                <button id="studentBtn" class="px-3 py-2 border border-gray-300 rounded-l-lg text-sm focus:outline-none">دانش‌آموز</button>
            </div>
            <!-- Profile Dropdown -->
            <div class="relative" id="profile-menu-container">
                <button id="profile-menu-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 border-indigo-300 hover:border-indigo-500 transition-all">
                    <img id="profile-img" src="https://placehold.co/40x40/c7d2fe/312e81?text=U" alt="پروفایل">
                </button>
                <div id="profile-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30">
                    <a href="#" id="open-profile-modal-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ویرایش پروفایل</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content: Calendar -->
    <main class="p-4 calendar-container">
        <div id="calendar-grid" class="calendar-grid">
            <!-- Calendar columns will be injected here by JS -->
        </div>
    </main>

    <!-- Floating Chat Button -->
    <button id="chat-toggle-btn" class="fixed bottom-6 left-6 w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-full shadow-lg text-white flex items-center justify-center z-30 transition-transform hover:scale-110">
        <i class="fas fa-comments fa-2x"></i>
        <span id="chat-notification-dot" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden"></span>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden fixed bottom-24 left-6 w-96 max-w-[90vw] h-[500px] bg-white rounded-xl shadow-2xl z-30 flex flex-col transition-all duration-300">
        <div id="chat-header" class="p-3 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-t-xl flex items-center justify-between">
            <h3 id="chat-title" class="font-bold">چت‌ها</h3>
            <button id="back-to-chats-btn" class="hidden"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div id="chat-body" class="flex-1 overflow-hidden flex flex-col">
             <div id="chat-list" class="h-full overflow-y-auto"></div>
             <div id="chat-messages-view" class="h-full flex-col hidden">
                 <div class="chat-messages flex-1 p-3 space-y-4 overflow-y-auto"></div>
                 <div class="p-2 border-t bg-gray-50 flex items-center gap-2">
                     <div class="flex-1 relative">
                        <input id="chat-input" type="text" class="w-full p-2 border rounded-full pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="پیام...">
                        <button id="chat-emoji-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-indigo-600" type="button"><i class="fas fa-smile"></i></button>
                     </div>
                     <button id="chat-send-btn" class="text-white bg-indigo-600 hover:bg-indigo-700 p-2 rounded-full w-10 h-10 flex items-center justify-center" type="button"><i class="fas fa-paper-plane"></i></button>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-md modal-enter">
            <h2 class="text-xl font-bold mb-4">ویرایش پروفایل</h2>
            <div class="flex flex-col items-center">
                <img id="modal-profile-img" src="https://placehold.co/100x100/c7d2fe/312e81?text=U" class="w-24 h-24 rounded-full mb-4 ring-4 ring-indigo-200">
                <input type="file" id="profile-img-upload" class="text-sm">
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button data-close-modal="profile-modal" class="px-4 py-2 bg-gray-200 rounded-lg">انصراف</button>
                <button id="save-profile-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ذخیره</button>
            </div>
        </div>
    </div>
    <!-- Course Details Modal -->
    <div id="course-details-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div id="course-details-content" class="bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl flex flex-col modal-enter"></div>
    </div>
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-5xl flex h-[80vh] modal-enter">
            <div class="w-1/4 bg-gray-800 text-white rounded-r-xl p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-6">پنل مدیریت</h2>
                <nav id="admin-menu" class="flex flex-col gap-2">
                    <button data-view="add-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 active">
                        <i class="fas fa-user-plus w-5"></i><span>افزودن دانش‌آموز</span>
                    </button>
                    <button data-view="assign-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-calendar-check w-5"></i><span>تخصیص دانش‌آموز</span>
                    </button>
                    <button data-view="send-notification" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-paper-plane w-5"></i><span>ارسال نوتیفیکیشن</span>
                    </button>
                    <button data-view="reports" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-chart-line w-5"></i><span>گزارش‌ها</span>
                    </button>
                     <button data-view="financials" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-dollar-sign w-5"></i><span>امور مالی</span>
                    </button>
                </nav>
                 <button data-close-modal="admin-panel-modal" class="mt-auto text-center p-3 bg-red-600 hover:bg-red-700 rounded-lg">بستن پنل</button>
            </div>
            <div id="admin-panel-content" class="w-3/4 p-6 overflow-y-auto"></div>
         </div>
    </div>
     <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-lg modal-enter">
            <h2 class="text-xl font-bold mb-4">ثبت اطلاعات پرداخت</h2>
             <p class="text-sm text-gray-600 mb-4">پس از واریز مبلغ دوره، لطفا اطلاعات زیر را برای تایید توسط ادمین تکمیل و ارسال نمایید.</p>
            <form id="payment-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">مبلغ واریز شده (تومان)</label><input name="amount" type="number" min="0" step="1000" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">شماره پیگیری / ارجاع</label><input name="reference_number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">تاریخ واریز</label><input name="payment_date" type="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="text-left pt-4">
                    <button type="button" data-close-modal="payment-modal" class="px-4 py-2 bg-gray-200 rounded-lg">انصراف</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ارسال برای تایید</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CURRENT_USER = JSON.parse('{{ dashboard_user_context|escapejs }}');

            const EN_TO_FA_DAYS = {
                Saturday: 'شنبه',
                Sunday: 'یکشنبه',
                Monday: 'دوشنبه',
                Tuesday: 'سه‌شنبه',
                Wednesday: 'چهارشنبه',
                Thursday: 'پنج‌شنبه',
                Friday: 'جمعه',
            };
            const FA_TO_EN_DAYS = Object.entries(EN_TO_FA_DAYS).reduce((acc, [en, fa]) => {
                acc[fa] = en;
                return acc;
            }, {});
            const daysOfWeek = Object.values(EN_TO_FA_DAYS);

            const state = {
                courses: [],
                payments: [],
                paymentsLoaded: false,
                conversations: [],
                conversationsLoaded: false,
                chatMessages: {},
                adminData: null,
            };

            const calendarGrid = document.getElementById('calendar-grid');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const adminControls = document.getElementById('admin-controls');
            const studentControls = document.getElementById('student-controls');
            const counselorFilter = document.getElementById('counselor-filter');
            const adminPanelContent = document.getElementById('admin-panel-content');
            const chatWindow = document.getElementById('chat-window');
            const chatList = document.getElementById('chat-list');
            const chatMessagesView = document.getElementById('chat-messages-view');
            const chatMessagesContainer = chatMessagesView.querySelector('.chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatTitle = document.getElementById('chat-title');
            const backToChatsBtn = document.getElementById('back-to-chats-btn');
            const chatNotificationDot = document.getElementById('chat-notification-dot');
            const adminBtn = document.getElementById('adminBtn');
            const counselorBtn = document.getElementById('counselorBtn');
            const studentBtn = document.getElementById('studentBtn');
            const profileDropdown = document.getElementById('profile-dropdown');

            let currentRole = CURRENT_USER.isStaff ? 'admin' : (CURRENT_USER.role || 'student');
            let activeChatUserId = null;
            let activeChatDisplayName = '';
            let messagePollingInterval = null;
            let conversationPollingInterval = null;
            const CHAT_POLL_INTERVAL = 5000;

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            async function fetchJSON(url, options = {}) {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const error = new Error(`Request failed with status ${response.status}`);
                    error.status = response.status;
                    throw error;
                }
                if (response.status === 204) {
                    return null;
                }
                return await response.json();
            }

            const extractFileName = (path) => {
                if (!path) return '';
                const parts = path.split('/');
                return parts[parts.length - 1] || path;
            };

            const transformCourse = (course) => {
                const sessions = (course.sessions || []).map(session => ({
                    id: session.id,
                    number: session.session_number,
                    date: session.date,
                    completed: session.is_completed,
                    videoUrl: session.video_url,
                }));
                const comments = (course.comments || []).map(comment => ({
                    id: comment.id,
                    authorName: comment.author?.full_name || `${comment.author?.first_name || ''} ${comment.author?.last_name || ''}`.trim(),
                    text: comment.text,
                    createdAt: comment.created_at,
                    attachment: comment.attachment,
                    voiceNote: comment.voice_note,
                }));
                const attachments = [];
                comments.forEach(comment => {
                    if (comment.attachment) {
                        attachments.push({
                            name: extractFileName(comment.attachment),
                            url: comment.attachment,
                        });
                    }
                    if (comment.voiceNote) {
                        attachments.push({
                            name: extractFileName(comment.voiceNote),
                            url: comment.voiceNote,
                        });
                    }
                });

                return {
                    id: course.id,
                    studentId: course.student,
                    advisorId: course.advisor,
                    studentName: course.student_name || '---',
                    advisorName: course.advisor_name || '---',
                    dayOfWeek: EN_TO_FA_DAYS[course.day_of_week] || course.day_of_week,
                    startTime: course.start_time,
                    time: course.start_time ? course.start_time.slice(0, 5) : '',
                    startDate: course.start_date,
                    isActive: course.is_active,
                    sessions,
                    comments,
                    attachments,
                };
            };

            async function loadCourses() {
                try {
                    const courses = await fetchJSON('/courses/');
                    state.courses = courses.map(transformCourse);
                } catch (error) {
                    console.error('Error loading courses:', error);
                    state.courses = [];
                }
            }

            function updateCounselorFilterOptions() {
                if (!counselorFilter) return;
                const options = ['<option value="all">همه</option>'];
                const seen = new Map();
                state.courses.forEach(course => {
                    if (!course.advisorId) return;
                    if (!seen.has(course.advisorId)) {
                        seen.set(course.advisorId, course.advisorName);
                        options.push(`<option value="${course.advisorId}">${course.advisorName}</option>`);
                    }
                });
                counselorFilter.innerHTML = options.join('');
                counselorFilter.value = 'all';
                counselorFilter.disabled = !(currentRole === 'admin' && CURRENT_USER.isStaff);
            }

            async function loadPayments() {
                if (!CURRENT_USER.isStaff) {
                    state.payments = [];
                    state.paymentsLoaded = true;
                    return;
                }
                try {
                    const payments = await fetchJSON('/api/payments/');
                    state.payments = payments;
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error loading payments:', error);
                    }
                    state.payments = [];
                } finally {
                    state.paymentsLoaded = true;
                }
            }

            async function loadConversations(force = false) {
                if (state.conversationsLoaded && !force) {
                    return state.conversations;
                }
                try {
                    const conversations = await fetchJSON('/api/chat/conversations/');
                    state.conversations = Array.isArray(conversations) ? conversations : [];
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error loading conversations:', error);
                    }
                    state.conversations = [];
                } finally {
                    state.conversationsLoaded = true;
                    updateNotificationIndicator();
                }
                return state.conversations;
            }

            async function fetchChatMessages(userId, force = false) {
                if (!force && state.chatMessages[userId]) {
                    return state.chatMessages[userId];
                }
                try {
                    const messages = await fetchJSON(`/api/chat/messages/${userId}/`);
                    const normalized = Array.isArray(messages) ? messages : [];
                    state.chatMessages[userId] = normalized;
                    return normalized;
                } catch (error) {
                    console.error('Error loading chat messages:', error);
                    return state.chatMessages[userId] || [];
                }
            }

            function updateNotificationIndicator() {
                if (!chatNotificationDot) {
                    return;
                }
                const totalUnread = (state.conversations || []).reduce((sum, convo) => sum + (convo.unread_count || 0), 0);
                if (totalUnread > 0) {
                    chatNotificationDot.classList.remove('hidden');
                } else {
                    chatNotificationDot.classList.add('hidden');
                }
            }

            function getConversationDisplayName(convo) {
                if (!convo) {
                    return 'کاربر';
                }
                const nameParts = [];
                if (convo.profile) {
                    if (convo.profile.first_name) nameParts.push(convo.profile.first_name);
                    if (convo.profile.last_name) nameParts.push(convo.profile.last_name);
                }
                const displayName = nameParts.join(' ').trim();
                return displayName || convo.username || 'کاربر';
            }

            function populateChatList() {
                if (!chatList) {
                    return;
                }
                chatList.innerHTML = '';
                if (!state.conversations.length) {
                    chatList.innerHTML = '<p class="text-sm text-gray-500 p-3">گفتگویی یافت نشد.</p>';
                    updateNotificationIndicator();
                    return;
                }

                state.conversations.forEach(convo => {
                    const displayName = getConversationDisplayName(convo);
                    const lastMessage = convo.last_message || '';
                    const listItem = document.createElement('div');
                    listItem.className = 'p-3 flex items-center gap-3 hover:bg-gray-100 cursor-pointer border-b';
                    const avatarInitial = displayName.charAt(0) || '?';
                    listItem.innerHTML = `<img src="https://placehold.co/40x40/e0e7ff/4338ca?text=${avatarInitial}" class="w-10 h-10 rounded-full"><div><p class="font-bold">${displayName}</p><p class="text-sm text-gray-500 truncate">${lastMessage || 'بدون پیام'}</p></div>`;
                    listItem.addEventListener('click', () => {
                        renderMessages(convo.id, displayName).catch(error => {
                            console.error('Error rendering messages:', error);
                            chatMessagesContainer.innerHTML = '<p class="text-sm text-red-500">خطا در بارگذاری پیام‌ها.</p>';
                        });
                    });
                    chatList.appendChild(listItem);
                });

                updateNotificationIndicator();
            }

            function updateMessagesUI(userId) {
                if (!chatMessagesContainer) {
                    return;
                }
                const messages = state.chatMessages[userId] || [];
                chatMessagesContainer.innerHTML = '';
                if (!messages.length) {
                    chatMessagesContainer.innerHTML = '<p class="text-sm text-gray-500">پیامی ثبت نشده است.</p>';
                    return;
                }

                messages.forEach(msg => {
                    const msgBubble = document.createElement('div');
                    const isMe = msg.sender === CURRENT_USER.id;
                    msgBubble.className = `max-w-xs p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white self-end' : 'bg-gray-200 text-gray-800 self-start'}`;
                    msgBubble.textContent = msg.text || 'بدون متن';
                    chatMessagesContainer.appendChild(msgBubble);
                });
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }

            function haveMessagesChanged(previousMessages, nextMessages) {
                if (previousMessages.length !== nextMessages.length) {
                    return true;
                }
                if (!previousMessages.length) {
                    return false;
                }
                const prevLast = previousMessages[previousMessages.length - 1];
                const nextLast = nextMessages[nextMessages.length - 1];
                if (!prevLast && !nextLast) {
                    return false;
                }
                if (!prevLast || !nextLast) {
                    return true;
                }
                return prevLast.id !== nextLast.id || prevLast.timestamp !== nextLast.timestamp || prevLast.text !== nextLast.text || prevLast.is_read !== nextLast.is_read;
            }

            function startMessagePolling(userId) {
                stopMessagePolling();
                if (!userId) {
                    return;
                }
                messagePollingInterval = setInterval(async () => {
                    try {
                        const previousMessages = state.chatMessages[userId] ? [...state.chatMessages[userId]] : [];
                        const latestMessages = await fetchChatMessages(userId, true);
                        if (haveMessagesChanged(previousMessages, latestMessages)) {
                            updateMessagesUI(userId);
                        }
                    } catch (error) {
                        console.error('Error polling messages:', error);
                    }
                }, CHAT_POLL_INTERVAL);
            }

            function stopMessagePolling() {
                if (messagePollingInterval) {
                    clearInterval(messagePollingInterval);
                    messagePollingInterval = null;
                }
            }

            function startConversationPolling() {
                if (conversationPollingInterval) {
                    return;
                }
                conversationPollingInterval = setInterval(async () => {
                    if (chatWindow.classList.contains('hidden')) {
                        stopConversationPolling();
                        return;
                    }
                    try {
                        await loadConversations(true);
                        if (!chatList.classList.contains('hidden')) {
                            populateChatList();
                        }
                    } catch (error) {
                        console.error('Error refreshing conversations:', error);
                    }
                }, CHAT_POLL_INTERVAL);
            }

            function stopConversationPolling() {
                if (conversationPollingInterval) {
                    clearInterval(conversationPollingInterval);
                    conversationPollingInterval = null;
                }
            }

            async function handleSendMessage() {
                if (!chatInput || !chatSendBtn) {
                    return;
                }
                if (!activeChatUserId) {
                    alert('لطفا ابتدا یک گفتگو را انتخاب کنید.');
                    return;
                }
                const text = chatInput.value.trim();
                if (!text) {
                    chatInput.focus();
                    return;
                }

                chatSendBtn.disabled = true;
                try {
                    const response = await fetch(`/api/chat/messages/${activeChatUserId}/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify({ text }),
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || `خطا در ارسال پیام (کد ${response.status})`);
                    }
                    const newMessage = await response.json();
                    if (!Array.isArray(state.chatMessages[activeChatUserId])) {
                        state.chatMessages[activeChatUserId] = [];
                    }
                    state.chatMessages[activeChatUserId].push(newMessage);
                    updateMessagesUI(activeChatUserId);
                    chatInput.value = '';
                    chatInput.focus();
                    await loadConversations(true);
                    if (!chatList.classList.contains('hidden')) {
                        populateChatList();
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('ارسال پیام با خطا مواجه شد.');
                } finally {
                    chatSendBtn.disabled = false;
                }
            }

            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modalBackdrop.classList.remove('hidden');
                    modal.classList.remove('hidden');
                }
            };

            const closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    const content = modal.querySelector('.modal-enter');
                    if (content) content.classList.replace('modal-enter', 'modal-leave');
                    setTimeout(() => {
                        modalBackdrop.classList.add('hidden');
                        modal.classList.add('hidden');
                        if (content) content.classList.replace('modal-leave', 'modal-enter');
                    }, 300);
                }
            };

            const openCourseDetailsModal = (course) => {
                const modalContentContainer = document.getElementById('course-details-content');
                if (!modalContentContainer) return;

                const sessionsHtml = course.sessions.map((session, index) => `
                    <div class="flex items-center justify-between bg-indigo-50 rounded-lg p-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-white shadow">
                                <span class="font-bold text-indigo-600">${index + 1}</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">جلسه ${index + 1}</p>
                                <p class="text-xs text-gray-500">${session.date}</p>
                            </div>
                        </div>
                        <span class="text-sm ${session.completed ? 'text-green-600' : 'text-gray-400'}">
                            ${session.completed ? 'انجام شد' : 'در انتظار'}
                        </span>
                    </div>
                `).join('');

                const commentsHtml = course.comments.map(comment => `
                    <div class="p-3 bg-white rounded-lg shadow-sm border">
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-semibold text-gray-700">${comment.authorName || 'کاربر'}</p>
                            <span class="text-xs text-gray-400">${comment.createdAt ? new Date(comment.createdAt).toLocaleString('fa-IR') : ''}</span>
                        </div>
                        <p class="text-sm text-gray-600">${comment.text || 'بدون متن'}</p>
                    </div>
                `).join('');

                const attachmentsHtml = course.attachments.length
                    ? course.attachments.map(attachment => `
                        <a href="${attachment.url}" target="_blank" class="flex items-center gap-2 p-2 border rounded-lg hover:bg-gray-50">
                            <i class="fas fa-paperclip text-indigo-500"></i>
                            <span class="text-sm text-gray-700">${attachment.name}</span>
                        </a>
                    `).join('')
                    : '<p class="text-xs text-gray-400">فایلی ثبت نشده است.</p>';

                const weeklyPlanButton = (currentRole !== 'student') ? `
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                        <i class="fas fa-calendar-week"></i>
                        <span>مشاهده برنامه هفتگی</span>
                    </button>
                ` : '';

                modalContentContainer.innerHTML = `
                    <div class="flex justify-between items-center p-4 border-b">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${course.studentName}</h2>
                            <p class="text-sm text-gray-500">مشاور: ${course.advisorName}</p>
                        </div>
                        ${weeklyPlanButton}
                    </div>
                    <div class="p-4 space-y-4 overflow-y-auto">
                        <section>
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-clock text-indigo-500"></i> زمان‌بندی جلسات
                            </h3>
                            <div class="space-y-2">${sessionsHtml || '<p class="text-sm text-gray-500">جلسه‌ای برای این دوره ثبت نشده است.</p>'}</div>
                        </section>
                        <section>
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-comment-dots text-indigo-500"></i> نظرات
                            </h3>
                            <div class="space-y-2">${commentsHtml || '<p class="text-xs text-gray-400">نظری ثبت نشده است.</p>'}</div>
                        </section>
                        <section>
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-folder-open text-indigo-500"></i> فایل‌ها
                            </h3>
                            <div class="space-y-2">${attachmentsHtml}</div>
                        </section>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-b-xl border-t flex justify-end gap-3">
                        <button data-close-modal="course-details-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">بستن</button>
                        <button data-close-modal="course-details-modal" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ذخیره تغییرات</button>
                    </div>
                `;
                openModal('course-details-modal');

                const addCommentForm = modalContentContainer.querySelector('#add-comment-form');
                if (addCommentForm) {
                    addCommentForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const formData = new FormData(addCommentForm);
                        try {
                            const response = await fetch(`/courses/${course.id}/add-comment/`, {
                                method: 'POST',
                                headers: { 'X-CSRFToken': csrftoken },
                                body: formData,
                            });
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(errorText || 'خطا در ثبت نظر');
                            }
                            await response.json();
                            await loadCourses();
                            renderCalendar();
                            const refreshedCourse = state.courses.find(item => item.id === course.id);
                            if (refreshedCourse) {
                                renderCourseDetails(refreshedCourse);
                            }
                        } catch (error) {
                            alert('ثبت نظر با خطا مواجه شد.');
                        }
                    });
                }
            };

            const createCourseCard = (course) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm mb-3 course-card cursor-pointer';
                const totalSessions = course.sessions.length || 4;
                const completedSessions = course.sessions.filter(s => s.completed).length;
                const progressPercentage = totalSessions ? (completedSessions / totalSessions) * 100 : 0;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${course.studentName}</p>
                            <p class="text-sm text-indigo-600 font-semibold">${course.time || '—'}</p>
                        </div>
                        <div class="text-gray-400 text-lg hover:text-indigo-600">
                            <i class="fa-solid fa-square-arrow-up-right"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-gray-500 mb-1">پیشرفت دوره (${completedSessions} از ${totalSessions})</p>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openCourseDetailsModal(course));
                return card;
            };

            const renderCalendar = () => {
                if (!calendarGrid) return;
                calendarGrid.innerHTML = '';
                let filteredCourses = [...state.courses];

                if (currentRole === 'counselor' && CURRENT_USER.advisorId) {
                    filteredCourses = filteredCourses.filter(course => course.advisorId === CURRENT_USER.advisorId);
                } else if (currentRole === 'student' && CURRENT_USER.studentId) {
                    filteredCourses = filteredCourses.filter(course => course.studentId === CURRENT_USER.studentId);
                } else if (currentRole === 'admin' && CURRENT_USER.isStaff && counselorFilter && counselorFilter.value !== 'all') {
                    filteredCourses = filteredCourses.filter(course => String(course.advisorId) === counselorFilter.value);
                }

                daysOfWeek.forEach(day => {
                    const column = document.createElement('div');
                    column.className = 'day-column p-2';
                    column.innerHTML = `<h3 class="font-extrabold text-center p-2 text-gray-700">${day}</h3>`;
                    const dayCourses = filteredCourses.filter(course => course.dayOfWeek === day);
                    if (!dayCourses.length) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.className = 'text-sm text-gray-400 text-center py-4';
                        emptyMessage.textContent = 'جلسه‌ای ثبت نشده است.';
                        column.appendChild(emptyMessage);
                    } else {
                        dayCourses.forEach(course => column.appendChild(createCourseCard(course)));
                    }
                    calendarGrid.appendChild(column);
                });
            };

            const switchRole = (role, buttonElement) => {
                if (role === 'admin' && !CURRENT_USER.isStaff) {
                    alert('شما دسترسی ادمین ندارید.');
                    return;
                }
                currentRole = role;
                document.querySelectorAll('.view-switcher-active').forEach(btn => btn.classList.remove('view-switcher-active'));
                if (buttonElement) {
                    buttonElement.classList.add('view-switcher-active');
                }
                const showAdminControls = role === 'admin' && CURRENT_USER.isStaff;
                adminControls.classList.toggle('hidden', !showAdminControls);
                adminControls.classList.toggle('flex', showAdminControls);
                studentControls.classList.toggle('hidden', role !== 'student');
                studentControls.classList.toggle('flex', role === 'student');
                if (counselorFilter) {
                    counselorFilter.disabled = !showAdminControls;
                }
                chatWindow.classList.add('hidden');
                chatMessagesView.classList.add('hidden');
                chatMessagesView.style.display = 'none';
                chatList.classList.remove('hidden');
                stopConversationPolling();
                stopMessagePolling();
                activeChatUserId = null;
                activeChatDisplayName = '';
                renderCalendar();
            };

            async function renderMessages(userId, otherPartyName, options = {}) {
                const { force = false } = options;
                activeChatUserId = userId;
                if (typeof otherPartyName === 'string' && otherPartyName.trim()) {
                    activeChatDisplayName = otherPartyName;
                }

                chatList.classList.add('hidden');
                chatMessagesView.style.display = 'flex';
                chatMessagesView.classList.remove('hidden');
                backToChatsBtn.classList.remove('hidden');
                chatTitle.textContent = activeChatDisplayName || 'چت';
                chatMessagesContainer.innerHTML = '';

                await fetchChatMessages(userId, force);
                updateMessagesUI(userId);
                chatInput?.focus();

                await loadConversations(true);
                startMessagePolling(userId);
            }

            async function renderChatList(force = false) {
                chatMessagesContainer.innerHTML = '';
                chatMessagesView.classList.add('hidden');
                chatMessagesView.style.display = 'none';
                chatList.classList.remove('hidden');
                backToChatsBtn.classList.add('hidden');
                chatTitle.textContent = 'چت‌ها';
                activeChatUserId = null;
                activeChatDisplayName = '';
                stopMessagePolling();

                if (force) {
                    await loadConversations(true);
                } else if (!state.conversationsLoaded) {
                    await loadConversations();
                }

                populateChatList();
            }

            async function getAdminData(force = false) {
                if (!CURRENT_USER.isStaff) {
                    return null;
                }
                if (state.adminData && !force) {
                    return state.adminData;
                }
                try {
                    const data = await fetchJSON('/api/admin-panel-data/');
                    state.adminData = data;
                    return data;
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error fetching admin data:', error);
                    }
                    state.adminData = null;
                    return null;
                }
            }

            const renderAdminView = async (viewName) => {
                if (!CURRENT_USER.isStaff) {
                    adminPanelContent.innerHTML = '<p class="text-sm text-gray-600">دسترسی ادمین برای شما فعال نیست.</p>';
                    return;
                }

                document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => item.classList.remove('active'));
                const activeButton = document.querySelector(`#admin-menu .admin-menu-item[data-view="${viewName}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }

                adminPanelContent.innerHTML = '<div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;"></div>';

                let data = null;
                if (['add-student', 'assign-student'].includes(viewName)) {
                    data = await getAdminData();
                    if (!data) {
                        adminPanelContent.innerHTML = '<p class="text-red-500">امکان بارگذاری اطلاعات وجود ندارد.</p>';
                        return;
                    }
                }

                let content = '';
                switch (viewName) {
                    case 'add-student': {
                        const gradeOptions = data.grades.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                        const majorOptions = data.majors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                        content = `
                            <h3 class="text-xl font-bold mb-4">فرم افزودن دانش‌آموز جدید</h3>
                            <form id="add-student-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700">نام</label><input name="first_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">نام خانوادگی</label><input name="last_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">شماره موبایل</label><input name="phone_number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">پایه تحصیلی</label><select name="grade_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${gradeOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">رشته</label><select name="major_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${majorOptions}</select></div>
                                <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">افزودن</button></div>
                            </form>`;
                        break;
                    }
                    case 'assign-student': {
                        const studentOptions = data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                        const advisorOptions = data.advisors.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                        const dayOptions = daysOfWeek.map(d => `<option value="${d}">${d}</option>`).join('');
                        content = `
                            <h3 class="text-xl font-bold mb-4">تخصیص دانش‌آموز به مشاور</h3>
                            <form id="assign-student-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700">انتخاب دانش‌آموز</label><select name="student_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${studentOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">انتخاب مشاور</label><select name="advisor_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${advisorOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">روز جلسه</label><select name="day_of_week" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${dayOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">تاریخ اولین جلسه</label><input name="start_date" type="date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">ساعت جلسه</label><input name="start_time" type="time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">تخصیص</button></div>
                            </form>`;
                        break;
                    }
                    case 'financials': {
                        await loadPayments();
                        if (!state.payments.length) {
                            content = '<p class="text-sm text-gray-600">پرداختی برای نمایش وجود ندارد.</p>';
                        } else {
                            const statusLabels = {
                                pending: 'در انتظار تایید',
                                approved: 'تایید شده',
                                rejected: 'رد شده',
                            };
                            const rows = state.payments.map(payment => `
                                <tr class="border-b">
                                    <td class="px-3 py-2 text-sm text-gray-700">${payment.student_name || '---'}</td>
                                    <td class="px-3 py-2 text-sm text-gray-700">${Number(payment.amount).toLocaleString('fa-IR')}</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${payment.reference_number}</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${payment.payment_date}</td>
                                    <td class="px-3 py-2 text-sm font-semibold">${statusLabels[payment.status] || payment.status}</td>
                                </tr>
                            `).join('');
                            content = `
                                <h3 class="text-xl font-bold mb-4">گزارش پرداخت‌ها</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                                        <thead class="bg-gray-100 text-gray-700 text-sm">
                                            <tr>
                                                <th class="px-3 py-2 text-right font-semibold">دانش‌آموز</th>
                                                <th class="px-3 py-2 text-right font-semibold">مبلغ (تومان)</th>
                                                <th class="px-3 py-2 text-right font-semibold">شماره پیگیری</th>
                                                <th class="px-3 py-2 text-right font-semibold">تاریخ پرداخت</th>
                                                <th class="px-3 py-2 text-right font-semibold">وضعیت</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rows}</tbody>
                                    </table>
                                </div>`;
                        }
                        break;
                    }
                    case 'send-notification':
                        content = '<p class="text-sm text-gray-600">این بخش به زودی فعال می‌شود.</p>';
                        break;
                    case 'reports':
                        content = '<p class="text-sm text-gray-600">گزارشی برای نمایش وجود ندارد.</p>';
                        break;
                    default:
                        content = '<p class="text-sm text-gray-600">یک گزینه را از منو انتخاب کنید.</p>';
                }

                adminPanelContent.innerHTML = content;

                const addStudentForm = document.getElementById('add-student-form');
                if (addStudentForm) {
                    addStudentForm.addEventListener('submit', handleAddStudent);
                }
                const assignStudentForm = document.getElementById('assign-student-form');
                if (assignStudentForm) {
                    assignStudentForm.addEventListener('submit', handleAssignStudent);
                }
            };

            async function handleAddStudent(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/add-student/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (response.status === 201) {
                        alert(result.message);
                        state.adminData = null;
                        await renderAdminView('assign-student');
                    } else {
                        alert(`خطا: ${result.message || 'اطلاعات نامعتبر است.'}`);
                    }
                } catch (error) {
                    alert('یک خطای شبکه رخ داد.');
                }
            }

            async function handleAssignStudent(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                data.day_of_week = FA_TO_EN_DAYS[data.day_of_week] || data.day_of_week;

                try {
                    const response = await fetch('/api/assign-student/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (response.status === 201) {
                        alert(result.message);
                        state.adminData = null;
                        await loadCourses();
                        updateCounselorFilterOptions();
                        renderCalendar();
                        await renderAdminView('assign-student');
                    } else {
                        alert(`خطا: ${result.message || 'اطلاعات نامعتبر است.'}`);
                    }
                } catch (error) {
                    alert('یک خطای شبکه رخ داد.');
                }
            }

            const roleButtonMap = {
                admin: adminBtn,
                counselor: counselorBtn,
                student: studentBtn,
            };

            if (adminBtn) {
                adminBtn.addEventListener('click', (e) => {
                    if (!CURRENT_USER.isStaff) {
                        alert('شما دسترسی ادمین ندارید.');
                        return;
                    }
                    switchRole('admin', e.currentTarget);
                });
            }
            if (counselorBtn) {
                counselorBtn.addEventListener('click', (e) => switchRole('counselor', e.currentTarget));
            }
            if (studentBtn) {
                studentBtn.addEventListener('click', (e) => switchRole('student', e.currentTarget));
            }

            if (counselorFilter) {
                counselorFilter.addEventListener('change', () => renderCalendar());
            }

            document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => {
                item.addEventListener('click', () => renderAdminView(item.dataset.view));
            });

            const openAdminPanelBtn = document.getElementById('open-admin-panel-btn');
            if (openAdminPanelBtn) {
                openAdminPanelBtn.addEventListener('click', () => {
                    renderAdminView('add-student');
                    openModal('admin-panel-modal');
                });
            }

            const openPaymentModalBtn = document.getElementById('open-payment-modal-btn');
            if (openPaymentModalBtn) {
                openPaymentModalBtn.addEventListener('click', () => openModal('payment-modal'));
            }

            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            if (chatToggleBtn) {
                chatToggleBtn.addEventListener('click', () => {
                    chatWindow.classList.toggle('hidden');
                    const isHidden = chatWindow.classList.contains('hidden');
                    if (!isHidden) {
                        renderChatList().catch(error => {
                            console.error('Error rendering chat list:', error);
                            chatList.innerHTML = '<p class="text-sm text-red-500 p-3">خطا در بارگذاری چت.</p>';
                        });
                        startConversationPolling();
                    } else {
                        stopConversationPolling();
                        stopMessagePolling();
                        activeChatUserId = null;
                        activeChatDisplayName = '';
                        chatMessagesView.classList.add('hidden');
                        chatMessagesView.style.display = 'none';
                        chatList.classList.remove('hidden');
                        chatTitle.textContent = 'چت‌ها';
                    }
                });
            }

            backToChatsBtn.addEventListener('click', () => {
                renderChatList(true).catch(error => {
                    console.error('Error rendering chat list:', error);
                    chatList.innerHTML = '<p class="text-sm text-red-500 p-3">خطا در بارگذاری چت.</p>';
                });
            });

            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', () => {
                    handleSendMessage().catch(error => {
                        console.error('Error sending message:', error);
                    });
                });
            }

            if (chatInput) {
                chatInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        handleSendMessage().catch(error => {
                            console.error('Error sending message:', error);
                        });
                    }
                });
            }

            const profileMenuBtn = document.getElementById('profile-menu-btn');
            if (profileMenuBtn && profileDropdown) {
                profileMenuBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.body.addEventListener('click', () => profileDropdown.classList.add('hidden'));
            }

            const openProfileModalBtn = document.getElementById('open-profile-modal-btn');
            if (openProfileModalBtn) {
                openProfileModalBtn.addEventListener('click', () => openModal('profile-modal'));
            }

            const modalImg = document.getElementById('modal-profile-img');
            const uploadInput = document.getElementById('profile-img-upload');
            const profileImg = document.getElementById('profile-img');
            const saveProfileBtn = document.getElementById('save-profile-btn');

            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', () => {
                    if (uploadInput.files && uploadInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            if (profileImg) profileImg.src = e.target.result;
                            if (modalImg) modalImg.src = e.target.result;
                        };
                        reader.readAsDataURL(uploadInput.files[0]);
                    }
                    closeModal('profile-modal');
                });
            }

            if (uploadInput) {
                uploadInput.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            if (modalImg) modalImg.src = e.target.result;
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }

            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                        if (!modal.classList.contains('hidden')) {
                            closeModal(modal.id);
                        }
                    });
                }
            });

            document.body.addEventListener('click', e => {
                const closeButton = e.target.closest('[data-close-modal]');
                if (closeButton) {
                    closeModal(closeButton.dataset.closeModal);
                }
            });

            const initializeDashboard = async () => {
                await loadCourses();
                updateCounselorFilterOptions();
                renderCalendar();
                if (CURRENT_USER.isStaff) {
                    loadPayments();
                }
                const initialButton = roleButtonMap[currentRole] || roleButtonMap.admin;
                if (initialButton) {
                    switchRole(currentRole, initialButton);
                } else {
                    renderCalendar();
                }
            };

            initializeDashboard();
            updateNotificationIndicator();
        });
    </script>
</body>
</html>
