<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©ÛŒÙ…ÛŒØ§Ú¯Ø± Ø®ÙˆÙ†Ù‡ - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Persian Datepicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc; /* gray-50 */
            overflow-y: hidden; /* Prevent vertical scroll on body */
        }
        .calendar-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            height: calc(100vh - 70px); /* Adjust based on header height */
        }
        .calendar-grid {
            display: grid;
            /* Mobile-first: fixed column width to enable horizontal scroll */
            grid-template-columns: repeat(7, 280px);
            gap: 1rem;
            min-height: calc(100vh - 140px);
        }
        /* On desktop (lg screens and up), columns become flexible and fill the space */
        @media (min-width: 1024px) {
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
        }
        .day-column {
            background-color: #f1f5f9; /* gray-100 */
            border-radius: 0.75rem;
            height: 100%;
            overflow-y: auto;
        }
        .view-switcher-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        /* Custom scrollbar */
        .day-column::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .modal-body::-webkit-scrollbar, #admin-panel-content::-webkit-scrollbar, .calendar-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .day-column::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb, #admin-panel-content::-webkit-scrollbar-thumb, .calendar-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        /* Card Hover Animation */
        .course-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .course-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Modal Animation */
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .admin-menu-item.active {
            background-color: #4f46e5;
            color: white;
        }
        .toast-message {
            direction: rtl;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(15 23 42 / 0.25);
            color: #fff;
            animation: fadeIn 0.2s ease-out;
            font-size: 0.875rem;
        }
        .toast-message.success {
            background: linear-gradient(135deg, #16a34a, #22c55e);
        }
        .toast-message.error {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        .toast-message.info {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
</head>
<body class="w-full h-screen">

    <div id="toast-container" class="fixed top-6 right-6 flex flex-col gap-3 z-50"></div>

    <!-- Header -->
    <header class="bg-white shadow-md p-3 flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-rocket text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-extrabold text-gray-800">Ú©ÛŒÙ…ÛŒØ§Ú¯Ø± Ø®ÙˆÙ†Ù‡</h1>
        </div>
        <div class="flex items-center gap-4">
            <!-- Admin Specific Controls -->
            <div id="admin-controls" class="hidden items-center gap-4">
                <button id="open-admin-panel-btn" class="flex items-center gap-2 px-3 py-2 bg-gray-800 text-white rounded-lg text-sm hover:bg-gray-900">
                    <i class="fas fa-shield-halved"></i>
                    <span>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</span>
                </button>
                <div class="items-center gap-2 hidden sm:flex">
                     <label for="counselor-filter" class="text-sm text-gray-600">ÙÛŒÙ„ØªØ± Ù…Ø´Ø§ÙˆØ±:</label>
                     <select id="counselor-filter" class="rounded-md border-gray-300 shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 min-w-[220px]" data-placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´Ø§ÙˆØ±" autocomplete="off">
                         <option value="all">Ù‡Ù…Ù‡</option>
                     </select>
                </div>
            </div>
             <!-- Student Specific Controls -->
            <div id="student-controls" class="hidden items-center gap-4">
                <button id="open-payment-modal-btn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Ø§Ù…ÙˆØ± Ù…Ø§Ù„ÛŒ</span>
                </button>
            </div>
            <!-- Active Role Indicator -->
            <button id="notifications-btn" class="relative flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 bg-white text-gray-600 hover:border-indigo-400 hover:text-indigo-600 transition">
                <i class="fas fa-bell"></i>
                <span id="notifications-badge" class="hidden absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center"></span>
            </button>
            <div id="role-indicator" class="hidden px-3 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-semibold"></div>
            <!-- Profile Dropdown -->
            <div class="relative" id="profile-menu-container">
                <button id="profile-menu-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 border-indigo-300 hover:border-indigo-500 transition-all">
                    <img id="profile-img" src="https://placehold.co/40x40/c7d2fe/312e81?text=U" alt="Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
                </button>
                <div id="profile-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30">
                    <a href="#" id="open-profile-modal-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
                    <form id="logout-form" method="post" action="{% url 'logout' %}" class="px-0">
                        {% csrf_token %}
                        <button type="submit" class="w-full text-right block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ø®Ø±ÙˆØ¬</button>
                    </form>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content: Calendar -->
    <main class="p-4 calendar-container">
        <div id="calendar-grid" class="calendar-grid">
            <!-- Calendar columns will be injected here by JS -->
        </div>
    </main>

    <!-- Floating Chat Button -->
    <button id="chat-toggle-btn" class="fixed bottom-6 left-6 w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-full shadow-lg text-white flex items-center justify-center z-30 transition-transform hover:scale-110">
        <i class="fas fa-comments fa-2x"></i>
        <span id="chat-notification-dot" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden"></span>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden fixed bottom-24 left-6 w-96 max-w-[90vw] h-[500px] bg-white rounded-xl shadow-2xl z-30 flex flex-col transition-all duration-300">
        <div id="chat-header" class="p-3 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-t-xl flex items-center justify-between">
            <h3 id="chat-title" class="font-bold">Ú†Øªâ€ŒÙ‡Ø§</h3>
            <button id="back-to-chats-btn" class="hidden"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div id="chat-body" class="flex-1 overflow-hidden flex flex-col">
             <div id="chat-list" class="h-full overflow-y-auto"></div>
             <div id="chat-messages-view" class="h-full flex-col hidden">
                 <div class="chat-messages flex-1 p-3 space-y-4 overflow-y-auto"></div>
                 <div class="p-2 border-t bg-gray-50 space-y-2">
                     <div id="chat-attachment-preview" class="hidden flex flex-col gap-2"></div>
                     <div class="flex items-center gap-2">
                         <input id="chat-file-input" type="file" class="hidden">
                         <button id="chat-file-btn" class="w-10 h-10 flex items-center justify-center rounded-full border border-indigo-100 text-indigo-600 hover:bg-indigo-50" type="button" title="Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„">
                             <i class="fas fa-paperclip"></i>
                         </button>
                         <button id="chat-voice-btn" class="w-10 h-10 flex items-center justify-center rounded-full border border-amber-100 text-amber-600 hover:bg-amber-50" type="button" title="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ">
                             <i class="fas fa-microphone"></i>
                         </button>
                         <div class="flex-1 relative">
                            <input id="chat-input" type="text" class="w-full p-2 border rounded-full pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Ù¾ÛŒØ§Ù…...">
                            <button id="chat-emoji-btn" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-indigo-600" type="button" title="Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ…ÙˆØ¬ÛŒ"><i class="fas fa-smile"></i></button>
                         </div>
                         <button id="chat-send-btn" class="text-white bg-indigo-600 hover:bg-indigo-700 p-2 rounded-full w-10 h-10 flex items-center justify-center" type="button" title="Ø§Ø±Ø³Ø§Ù„"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-md modal-enter">
            <h2 class="text-xl font-bold mb-4">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>
            <div class="flex flex-col items-center">
                <img id="modal-profile-img" src="https://placehold.co/100x100/c7d2fe/312e81?text=U" class="w-24 h-24 rounded-full mb-4 ring-4 ring-indigo-200">
                <input type="file" id="profile-img-upload" class="text-sm">
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button data-close-modal="profile-modal" class="px-4 py-2 bg-gray-200 rounded-lg">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="save-profile-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>
    <!-- Course Details Modal -->
    <div id="course-details-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div id="course-details-content" class="bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl flex flex-col modal-enter"></div>
    </div>
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
         <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-5xl flex h-[80vh] modal-enter">
            <div class="w-1/4 bg-gray-800 text-white rounded-r-xl p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-6">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
                <nav id="admin-menu" class="flex flex-col gap-2">
                    <button data-view="add-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 active">
                        <i class="fas fa-user-plus w-5"></i><span>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</span>
                    </button>
                    <button data-view="assign-student" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-calendar-check w-5"></i><span>ØªØ®ØµÛŒØµ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</span>
                    </button>
                    <button data-view="send-notification" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-paper-plane w-5"></i><span>Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</span>
                    </button>
                    <button data-view="reports" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-chart-line w-5"></i><span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</span>
                    </button>
                     <button data-view="financials" class="admin-menu-item text-right flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700">
                         <i class="fas fa-dollar-sign w-5"></i><span>Ø§Ù…ÙˆØ± Ù…Ø§Ù„ÛŒ</span>
                    </button>
                </nav>
                 <button data-close-modal="admin-panel-modal" class="mt-auto text-center p-3 bg-red-600 hover:bg-red-700 rounded-lg">Ø¨Ø³ØªÙ† Ù¾Ù†Ù„</button>
            </div>
            <div id="admin-panel-content" class="w-3/4 p-6 overflow-y-auto"></div>
         </div>
    </div>
     <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-lg modal-enter">
            <h2 class="text-xl font-bold mb-4">Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
             <p class="text-sm text-gray-600 mb-4">Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ù…Ø¨Ù„Øº Ø¯ÙˆØ±Ù‡ØŒ Ù„Ø·ÙØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ† ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
            <form id="payment-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ² Ø´Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</label><input name="amount" type="number" min="0" step="1000" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ / Ø§Ø±Ø¬Ø§Ø¹</label><input name="reference_number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±ÛŒØ²</label>
                    <div class="mt-1 relative">
                        <input id="payment-date-display" type="text" required autocomplete="off" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® (Ù…Ø«Ø§Ù„: Û±Û´Û°Û²/Û°Û¸/Û±Û²)" class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-indigo-500">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                    </div>
                    <input id="payment-date-hidden" type="hidden" name="payment_date">
                    <p class="mt-1 text-xs text-gray-500">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø§ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
                </div>
                <div class="flex items-center justify-between pt-4 gap-3">
                    <button type="button" data-close-modal="payment-modal" class="px-4 py-2 bg-gray-200 rounded-lg">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button id="payment-submit-btn" type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯</button>
                </div>
                <p id="payment-feedback" class="text-sm hidden"></p>
            </form>
            <div id="student-payment-history" class="mt-6"></div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="hidden fixed inset-0 flex justify-center items-center z-40 p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-11/12 max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between border-b px-6 py-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</h3>
                    <p class="text-xs text-gray-500">Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ± Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                </div>
                <button class="text-gray-500 hover:text-gray-700" data-close-modal="notifications-modal">
                    <i class="fas fa-xmark text-xl"></i>
                </button>
            </div>
            <div id="notifications-error" class="hidden px-6 pt-4 text-sm text-red-600"></div>
            <div class="flex-1 overflow-y-auto px-6 py-4">
                <p id="notifications-loading" class="text-sm text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§...</p>
                <p id="notifications-empty" class="hidden text-sm text-gray-500">Ø§Ø¹Ù„Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
                <div id="notifications-list" class="space-y-3"></div>
            </div>
            <div class="px-6 py-3 border-t bg-gray-50 flex justify-end">
                <button id="notifications-refresh-btn" class="px-4 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-100 rounded-lg transition">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CURRENT_USER = JSON.parse('{{ dashboard_user_context|escapejs }}');

            const EN_TO_FA_DAYS = {
                Saturday: 'Ø´Ù†Ø¨Ù‡',
                Sunday: 'ÛŒÚ©Ø´Ù†Ø¨Ù‡',
                Monday: 'Ø¯ÙˆØ´Ù†Ø¨Ù‡',
                Tuesday: 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡',
                Wednesday: 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡',
                Thursday: 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡',
                Friday: 'Ø¬Ù…Ø¹Ù‡',
            };
            const FA_TO_EN_DAYS = Object.entries(EN_TO_FA_DAYS).reduce((acc, [en, fa]) => {
                acc[fa] = en;
                return acc;
            }, {});
            const daysOfWeek = Object.values(EN_TO_FA_DAYS);
            const ROLE_LABELS = {
                admin: 'Ù†Ù…Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†',
                counselor: 'Ù†Ù…Ø§ÛŒ Ù…Ø´Ø§ÙˆØ±',
                student: 'Ù†Ù…Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²',
            };

            const EMOJI_PICKER_EMOJIS = ['ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ˜', 'ğŸ¤”', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ™', 'ğŸ”¥', 'âœ¨', 'ğŸ’¯', 'ğŸ‰'];
            const PROFILE_PLACEHOLDER_SMALL = 'https://placehold.co/40x40/c7d2fe/312e81?text=U';
            const PROFILE_PLACEHOLDER_LARGE = 'https://placehold.co/100x100/c7d2fe/312e81?text=U';

            const state = {
                profile: null,
                profileLoaded: false,
                profileLoading: false,
                profileImageVersion: null,
                courses: [],
                advisors: [],
                advisorsLoaded: false,
                payments: [],
                paymentsLoaded: false,
                studentPayments: [],
                studentPaymentsLoaded: false,
                conversations: [],
                conversationsLoaded: false,
                chatMessages: {},
                adminData: null,
                reportData: null,
                reportsLoaded: false,
                reportFilters: null,
                reportLoading: false,
                notifications: [],
                notificationsLoaded: false,
                notificationLoading: false,
                notificationsError: null,
                notificationRecipients: [],
                notificationRecipientsLoaded: false,
                notificationRecipientsLoading: false,
                notificationRecipientsError: null,
            };

            let activeCourseId = null;

            const calendarGrid = document.getElementById('calendar-grid');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const adminControls = document.getElementById('admin-controls');
            const studentControls = document.getElementById('student-controls');
            const counselorFilter = document.getElementById('counselor-filter');
            const adminPanelContent = document.getElementById('admin-panel-content');
            const chatWindow = document.getElementById('chat-window');
            const chatList = document.getElementById('chat-list');
            const chatMessagesView = document.getElementById('chat-messages-view');
            const chatMessagesContainer = chatMessagesView.querySelector('.chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatEmojiBtn = document.getElementById('chat-emoji-btn');
            const chatFileInput = document.getElementById('chat-file-input');
            const chatFileBtn = document.getElementById('chat-file-btn');
            const chatVoiceBtn = document.getElementById('chat-voice-btn');
            const chatAttachmentPreview = document.getElementById('chat-attachment-preview');
            const chatTitle = document.getElementById('chat-title');
            const backToChatsBtn = document.getElementById('back-to-chats-btn');
            const chatNotificationDot = document.getElementById('chat-notification-dot');
            const paymentForm = document.getElementById('payment-form');
            const paymentFeedback = document.getElementById('payment-feedback');
            const paymentSubmitBtn = document.getElementById('payment-submit-btn');
            const studentPaymentHistoryContainer = document.getElementById('student-payment-history');
            const paymentDateDisplayInput = document.getElementById('payment-date-display');
            const paymentDateHiddenInput = document.getElementById('payment-date-hidden');
            const adminBtn = document.getElementById('adminBtn');
            const counselorBtn = document.getElementById('counselorBtn');
            const studentBtn = document.getElementById('studentBtn');
            const roleIndicator = document.getElementById('role-indicator');
            const profileDropdown = document.getElementById('profile-dropdown');
            const notificationsBtn = document.getElementById('notifications-btn');
            const notificationsBadge = document.getElementById('notifications-badge');
            const notificationsModal = document.getElementById('notifications-modal');
            const notificationsListContainer = document.getElementById('notifications-list');
            const notificationsLoading = document.getElementById('notifications-loading');
            const notificationsEmpty = document.getElementById('notifications-empty');
            const notificationsError = document.getElementById('notifications-error');
            const notificationsRefreshBtn = document.getElementById('notifications-refresh-btn');
            const profileImg = document.getElementById('profile-img');
            const modalImg = document.getElementById('modal-profile-img');
            const uploadInput = document.getElementById('profile-img-upload');
            const saveProfileBtn = document.getElementById('save-profile-btn');

            let currentRole = CURRENT_USER.isStaff ? 'admin' : (CURRENT_USER.role || 'student');
            let activeChatUserId = null;
            let activeChatDisplayName = '';
            let messagePollingInterval = null;
            let conversationPollingInterval = null;
            const CHAT_POLL_INTERVAL = 5000;
            let studentPaymentPollingInterval = null;
            const STUDENT_PAYMENT_POLL_INTERVAL = 15000;
            let counselorSelectInstance = null;
            let notificationRecipientSelectInstance = null;
            let notificationPollingInterval = null;
            const NOTIFICATION_POLL_INTERVAL = 15000;
            let chatSelectedFile = null;
            let chatVoiceBlob = null;
            let chatVoicePreviewUrl = null;
            let chatVoiceRecorder = null;
            let chatVoiceStream = null;
            let chatVoiceChunks = [];
            let chatVoiceRecording = false;
            let chatVoiceStopOptions = { save: true, notify: true };
            let emojiPickerElement = null;
            let emojiPickerVisible = false;

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            function setCounselorFilterDisabled(disabled) {
                if (!counselorFilter) return;
                counselorFilter.disabled = disabled;
                if (counselorSelectInstance) {
                    if (disabled) {
                        counselorSelectInstance.disable();
                    } else {
                        counselorSelectInstance.enable();
                    }
                }
            }

            function initializeCounselorSelect(selectedValue = 'all') {
                if (!counselorFilter || typeof TomSelect === 'undefined') {
                    return;
                }

                if (counselorSelectInstance) {
                    counselorSelectInstance.destroy();
                    counselorSelectInstance = null;
                }

                counselorSelectInstance = new TomSelect(counselorFilter, {
                    allowEmptyOption: true,
                    create: false,
                    maxOptions: 500,
                    persist: false,
                    placeholder: counselorFilter.dataset.placeholder || 'Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´Ø§ÙˆØ±',
                    sortField: [{ field: 'text', direction: 'asc' }],
                    searchField: ['text'],
                    render: {
                        option: (data, escape) => `<div class="text-sm">${escape(data.text)}</div>`,
                        item: (data, escape) => `<div class="text-sm">${escape(data.text)}</div>`,
                    },
                });

                const valueToSet = selectedValue || 'all';
                counselorSelectInstance.setValue(valueToSet, true);

                if (counselorFilter.disabled) {
                    counselorSelectInstance.disable();
                }
            }

            const toastContainer = document.getElementById('toast-container');
            const showToast = (message, type = 'info') => {
                if (!toastContainer || !message) return;
                const icons = {
                    success: 'fa-circle-check',
                    error: 'fa-circle-exclamation',
                    info: 'fa-circle-info',
                };
                const toast = document.createElement('div');
                toast.className = `toast-message ${type}`;
                toast.innerHTML = `<i class="fas ${icons[type] || icons.info} text-white text-lg"></i><span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            };

            const resetVoiceButtonAppearance = () => {
                if (!chatVoiceBtn) {
                    return;
                }
                chatVoiceBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse', 'border-red-200', 'hover:bg-red-500');
                chatVoiceBtn.classList.add('border-amber-100', 'text-amber-600', 'hover:bg-amber-50');
                chatVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                chatVoiceBtn.title = 'Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ';
            };

            const updateAttachmentPreview = () => {
                if (!chatAttachmentPreview) {
                    return;
                }

                const hasFile = !!chatSelectedFile;
                const hasVoice = !!chatVoiceBlob;

                if (!hasVoice && chatVoicePreviewUrl) {
                    URL.revokeObjectURL(chatVoicePreviewUrl);
                    chatVoicePreviewUrl = null;
                }

                chatAttachmentPreview.innerHTML = '';

                if (!hasFile && !hasVoice) {
                    chatAttachmentPreview.classList.add('hidden');
                    return;
                }

                chatAttachmentPreview.classList.remove('hidden');

                if (hasFile && chatSelectedFile) {
                    const fileRow = document.createElement('div');
                    fileRow.className = 'flex items-center justify-between gap-2 bg-indigo-50 border border-indigo-100 text-indigo-700 px-3 py-2 rounded-lg';

                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'flex items-center gap-2 text-xs font-medium';
                    fileInfo.innerHTML = '<i class="fas fa-paperclip"></i>';
                    const fileName = document.createElement('span');
                    fileName.textContent = chatSelectedFile.name || 'ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡';
                    fileInfo.appendChild(fileName);

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.dataset.action = 'remove-file';
                    removeBtn.className = 'text-xs text-indigo-700 hover:text-indigo-900';
                    removeBtn.textContent = 'Ø­Ø°Ù';

                    fileRow.appendChild(fileInfo);
                    fileRow.appendChild(removeBtn);
                    chatAttachmentPreview.appendChild(fileRow);
                }

                if (hasVoice && chatVoiceBlob) {
                    if (!chatVoicePreviewUrl) {
                        chatVoicePreviewUrl = URL.createObjectURL(chatVoiceBlob);
                    }

                    const voiceWrapper = document.createElement('div');
                    voiceWrapper.className = 'flex flex-col gap-2 bg-amber-50 border border-amber-100 text-amber-700 px-3 py-2 rounded-lg';

                    const voiceHeader = document.createElement('div');
                    voiceHeader.className = 'flex items-center justify-between text-xs font-medium';

                    const voiceLabel = document.createElement('span');
                    voiceLabel.className = 'flex items-center gap-2';
                    voiceLabel.innerHTML = '<i class="fas fa-microphone"></i><span>Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„</span>';
                    voiceHeader.appendChild(voiceLabel);

                    const removeVoiceBtn = document.createElement('button');
                    removeVoiceBtn.type = 'button';
                    removeVoiceBtn.dataset.action = 'remove-voice';
                    removeVoiceBtn.className = 'text-xs text-amber-700 hover:text-amber-900';
                    removeVoiceBtn.textContent = 'Ø­Ø°Ù';
                    voiceHeader.appendChild(removeVoiceBtn);

                    const audioPreview = document.createElement('audio');
                    audioPreview.controls = true;
                    audioPreview.preload = 'auto';
                    audioPreview.src = chatVoicePreviewUrl;
                    audioPreview.className = 'w-full';

                    voiceWrapper.appendChild(voiceHeader);
                    voiceWrapper.appendChild(audioPreview);
                    chatAttachmentPreview.appendChild(voiceWrapper);
                }
            };

            const clearFileAttachment = ({ notify = false } = {}) => {
                chatSelectedFile = null;
                if (chatFileInput) {
                    chatFileInput.value = '';
                }
                updateAttachmentPreview();
                if (notify) {
                    showToast('ÙØ§ÛŒÙ„ Ø¶Ù…ÛŒÙ…Ù‡ Ø­Ø°Ù Ø´Ø¯.', 'info');
                }
            };

            const removeVoiceAttachment = ({ notify = false } = {}) => {
                if (chatVoiceRecording) {
                    stopVoiceRecording({ save: false, notify });
                    return;
                }
                if (chatVoicePreviewUrl) {
                    URL.revokeObjectURL(chatVoicePreviewUrl);
                    chatVoicePreviewUrl = null;
                }
                if (chatVoiceBlob && notify) {
                    showToast('Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø­Ø°Ù Ø´Ø¯.', 'info');
                }
                chatVoiceBlob = null;
                updateAttachmentPreview();
                resetVoiceButtonAppearance();
            };

            const stopVoiceRecording = ({ save = true, notify = true } = {}) => {
                if (!chatVoiceRecorder) {
                    if (!save) {
                        if (chatVoiceStream) {
                            chatVoiceStream.getTracks().forEach((track) => track.stop());
                            chatVoiceStream = null;
                        }
                        if (chatVoicePreviewUrl) {
                            URL.revokeObjectURL(chatVoicePreviewUrl);
                            chatVoicePreviewUrl = null;
                        }
                        if (notify && chatVoiceBlob) {
                            showToast('Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø­Ø°Ù Ø´Ø¯.', 'info');
                        }
                        chatVoiceBlob = null;
                        updateAttachmentPreview();
                        resetVoiceButtonAppearance();
                    }
                    chatVoiceRecording = false;
                    chatVoiceChunks = [];
                    chatVoiceStopOptions = { save: true, notify: true };
                    return;
                }

                chatVoiceStopOptions = { save, notify };
                try {
                    chatVoiceRecorder.stop();
                } catch (error) {
                    console.error('Error stopping voice recorder:', error);
                    if (chatVoiceStream) {
                        chatVoiceStream.getTracks().forEach((track) => track.stop());
                        chatVoiceStream = null;
                    }
                    chatVoiceRecorder = null;
                    chatVoiceRecording = false;
                    chatVoiceChunks = [];
                    if (!save) {
                        if (chatVoicePreviewUrl) {
                            URL.revokeObjectURL(chatVoicePreviewUrl);
                            chatVoicePreviewUrl = null;
                        }
                        chatVoiceBlob = null;
                        updateAttachmentPreview();
                    }
                    resetVoiceButtonAppearance();
                }
            };

            const startVoiceRecording = async () => {
                if (!chatVoiceBtn) {
                    return;
                }
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || typeof MediaRecorder === 'undefined') {
                    showToast('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', 'error');
                    return;
                }
                if (chatVoiceRecording) {
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    chatVoiceStream = stream;
                    chatVoiceChunks = [];
                    chatVoiceRecorder = new MediaRecorder(stream);
                    chatVoiceStopOptions = { save: true, notify: true };

                    chatVoiceRecorder.addEventListener('dataavailable', (event) => {
                        if (event.data && event.data.size > 0) {
                            chatVoiceChunks.push(event.data);
                        }
                    });

                    chatVoiceRecorder.addEventListener('stop', () => {
                        if (chatVoiceStream) {
                            chatVoiceStream.getTracks().forEach((track) => track.stop());
                            chatVoiceStream = null;
                        }

                        const { save, notify } = chatVoiceStopOptions || { save: true, notify: true };
                        const hasData = chatVoiceChunks.length > 0;

                        if (save && hasData) {
                            const mimeType = chatVoiceRecorder.mimeType || 'audio/webm';
                            chatVoiceBlob = new Blob(chatVoiceChunks, { type: mimeType });
                            if (chatVoicePreviewUrl) {
                                URL.revokeObjectURL(chatVoicePreviewUrl);
                                chatVoicePreviewUrl = null;
                            }
                            updateAttachmentPreview();
                            if (notify) {
                                showToast('Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Øª.', 'success');
                            }
                        } else {
                            if (chatVoicePreviewUrl) {
                                URL.revokeObjectURL(chatVoicePreviewUrl);
                                chatVoicePreviewUrl = null;
                            }
                            chatVoiceBlob = null;
                            updateAttachmentPreview();
                            if (notify) {
                                showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ù„ØºÙˆ Ø´Ø¯.', 'info');
                            }
                        }

                        chatVoiceRecorder = null;
                        chatVoiceRecording = false;
                        chatVoiceChunks = [];
                        chatVoiceStopOptions = { save: true, notify: true };
                        resetVoiceButtonAppearance();
                    });

                    chatVoiceRecorder.start();
                    chatVoiceRecording = true;
                    chatVoiceBtn.classList.remove('border-amber-100', 'text-amber-600', 'hover:bg-amber-50');
                    chatVoiceBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse', 'border-red-200', 'hover:bg-red-500');
                    chatVoiceBtn.innerHTML = '<i class="fas fa-square"></i>';
                    chatVoiceBtn.title = 'Ù¾Ø§ÛŒØ§Ù† Ø¶Ø¨Ø· ØµØ¯Ø§';
                    showToast('Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¢ØºØ§Ø² Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù† Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.', 'info');
                } catch (error) {
                    console.error('Voice recording error:', error);
                    showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª.', 'error');
                    if (chatVoiceStream) {
                        chatVoiceStream.getTracks().forEach((track) => track.stop());
                        chatVoiceStream = null;
                    }
                    chatVoiceRecorder = null;
                    chatVoiceRecording = false;
                    chatVoiceChunks = [];
                    chatVoiceStopOptions = { save: true, notify: true };
                    resetVoiceButtonAppearance();
                }
            };

            const handleVoiceButtonClick = () => {
                if (chatVoiceRecording) {
                    stopVoiceRecording({ save: true, notify: true });
                    return;
                }
                if (chatVoiceBlob) {
                    removeVoiceAttachment({ notify: false });
                }
                startVoiceRecording();
            };

            const resetChatComposer = ({ clearText = true } = {}) => {
                if (clearText && chatInput) {
                    chatInput.value = '';
                }
                clearFileAttachment();
                removeVoiceAttachment();
                hideEmojiPicker();
            };

            const toDateInstance = (value) => {
                if (!value) return null;
                if (value instanceof Date) {
                    return Number.isNaN(value.getTime()) ? null : value;
                }
                if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
                    const parsed = new Date(`${value}T00:00:00`);
                    return Number.isNaN(parsed.getTime()) ? null : parsed;
                }
                const parsed = new Date(value);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            };

            const formatToJalali = (value, options = { year: 'numeric', month: 'long', day: 'numeric' }) => {
                const date = toDateInstance(value);
                if (!date) return '';
                return new Intl.DateTimeFormat('fa-IR-u-ca-persian', options).format(date);
            };

            const formatToJalaliShort = (value) => (
                formatToJalali(value, { year: 'numeric', month: '2-digit', day: '2-digit' })
            );

            const formatToJalaliDateTime = (value) => {
                const date = toDateInstance(value);
                if (!date) return '';
                return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                }).format(date);
            };

            const formatChatTimestamp = (value) => {
                const date = toDateInstance(value);
                if (!date) {
                    return '';
                }
                try {
                    return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                    }).format(date);
                } catch (error) {
                    console.error('Error formatting chat timestamp:', error);
                    return '';
                }
            };

            const extractFileName = (path) => {
                if (!path || typeof path !== 'string') {
                    return 'ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª';
                }
                const withoutQuery = path.split('?')[0];
                const segments = withoutQuery.split('/');
                const lastSegment = segments.pop();
                return lastSegment || 'ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª';
            };

            const PERSIAN_DIGIT_MAP = {
                'Û°': '0', 'Û±': '1', 'Û²': '2', 'Û³': '3', 'Û´': '4',
                'Ûµ': '5', 'Û¶': '6', 'Û·': '7', 'Û¸': '8', 'Û¹': '9',
                'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
                'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9',
            };

            const toEnglishDigits = (value) => {
                if (typeof value !== 'string') {
                    return value;
                }
                return value.replace(/[Û°-Û¹Ù -Ù©]/g, (digit) => PERSIAN_DIGIT_MAP[digit] || digit);
            };

            const toISODateString = (value) => {
                const date = toDateInstance(value);
                if (!date) return '';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatCount = (value) => {
                const numberValue = Number(value || 0);
                return Number.isFinite(numberValue) ? numberValue.toLocaleString('fa-IR') : 'Û°';
            };

            const escapeHtml = (value) => {
                if (value === null || value === undefined) {
                    return '';
                }
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            const ensureReportFilters = () => {
                if (!state.reportFilters) {
                    const today = new Date();
                    const defaultEnd = toISODateString(today);
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 29);
                    const defaultStart = toISODateString(startDate);
                    state.reportFilters = {
                        startDate: defaultStart,
                        endDate: defaultEnd,
                        advisorId: 'all',
                    };
                }
                return state.reportFilters;
            };

            let paymentDatePickerInitialized = false;
            let useJalaliDatePicker = false;

            const updateHiddenPaymentDateFromDisplay = ({ silent = false } = {}) => {
                if (!paymentDateDisplayInput || !paymentDateHiddenInput) {
                    return;
                }
                const rawValue = toEnglishDigits(paymentDateDisplayInput.value.trim());
                if (!rawValue) {
                    paymentDateHiddenInput.value = '';
                    return;
                }
                if (typeof window.persianDate === 'function') {
                    try {
                        const normalized = rawValue.replace(/-/g, '/');
                        const persian = new window.persianDate(normalized);
                        paymentDateHiddenInput.value = persian.toCalendar('gregorian').format('YYYY-MM-DD');
                    } catch (error) {
                        paymentDateHiddenInput.value = '';
                        if (!silent) {
                            showToast('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù…Ø«Ø§Ù„: Û±Û´Û°Û²/Û°Û¸/Û±Û²', 'error');
                        }
                    }
                } else {
                    paymentDateHiddenInput.value = rawValue.replace(/\//g, '-');
                }
            };

            const initializePaymentDatePicker = () => {
                if (paymentDatePickerInitialized || !paymentDateDisplayInput) {
                    return;
                }
                const hasPersianPicker =
                    typeof window.$ === 'function' &&
                    window.$.fn &&
                    typeof window.$.fn.persianDatepicker === 'function' &&
                    typeof window.persianDate === 'function';

                if (hasPersianPicker && paymentDateHiddenInput) {
                    paymentDatePickerInitialized = true;
                    useJalaliDatePicker = true;
                    paymentDateDisplayInput.setAttribute('readonly', 'readonly');
                    window.$(paymentDateDisplayInput).persianDatepicker({
                        calendar: {
                            persian: { locale: 'fa', leapYearMode: 'algorithmic' },
                            gregorian: { locale: 'en', leapYearMode: 'algorithmic' },
                        },
                        format: 'YYYY/MM/DD',
                        altField: '#payment-date-hidden',
                        altFormat: 'YYYY-MM-DD',
                        initialValue: false,
                        autoClose: true,
                        toolbox: { calendarSwitch: { enabled: false } },
                        navigator: { scroll: { enabled: false } },
                        onSelect: (unix) => {
                            try {
                                const persian = new window.persianDate(unix);
                                paymentDateDisplayInput.value = persian.format('YYYY/MM/DD');
                                paymentDateHiddenInput.value = persian.toCalendar('gregorian').format('YYYY-MM-DD');
                            } catch (error) {
                                paymentDateHiddenInput.value = '';
                            }
                        },
                    });
                    if (paymentForm) {
                        paymentForm.addEventListener('reset', () => {
                            paymentDateDisplayInput.value = '';
                            paymentDateHiddenInput.value = '';
                        });
                    }
                } else {
                    paymentDatePickerInitialized = true;
                    useJalaliDatePicker = false;
                    if (paymentDateHiddenInput) {
                        paymentDateHiddenInput.removeAttribute('name');
                    }
                    paymentDateDisplayInput.removeAttribute('readonly');
                    paymentDateDisplayInput.setAttribute('type', 'date');
                    paymentDateDisplayInput.setAttribute('name', 'payment_date');
                    paymentDateDisplayInput.setAttribute('placeholder', 'ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                }
            };

            async function fetchJSON(url, options = {}) {
                const mergedOptions = {
                    credentials: 'same-origin',
                    ...options,
                };
                mergedOptions.headers = {
                    Accept: 'application/json',
                    ...(options.headers || {}),
                };

                const response = await fetch(url, mergedOptions);
                const isNoContent = response.status === 204;
                const rawPayload = isNoContent ? '' : await response.text();

                if (!response.ok) {
                    let message = `Request failed with status ${response.status}`;
                    if (rawPayload) {
                        try {
                            const errorData = JSON.parse(rawPayload);
                            message = errorData.detail || errorData.message || message;
                        } catch (parseError) {
                            // ignore json parse error for non-json responses
                        }
                    }
                    const error = new Error(message);
                    error.status = response.status;
                    throw error;
                }

                if (!rawPayload) {
                    return null;
                }

                try {
                    return JSON.parse(rawPayload);
                } catch (parseError) {
                    return null;
                }
            }

            function updateProfileImages() {
                const profileData = state.profile;
                const baseUrl = profileData && profileData.profile_picture_url
                    ? profileData.profile_picture_url
                    : null;

                if (!baseUrl) {
                    state.profileImageVersion = null;
                    if (profileImg) {
                        profileImg.src = PROFILE_PLACEHOLDER_SMALL;
                    }
                    if (modalImg) {
                        modalImg.src = PROFILE_PLACEHOLDER_LARGE;
                    }
                    return;
                }

                let finalUrl = baseUrl;
                const version = state.profileImageVersion;
                if (typeof version === 'number') {
                    finalUrl = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}cb=${version}`;
                }

                if (profileImg) {
                    profileImg.src = finalUrl;
                }
                if (modalImg) {
                    modalImg.src = finalUrl;
                }
            }

            function setProfileData(profileData, { cacheBust = false, loaded = true } = {}) {
                state.profile = profileData || null;
                state.profileLoaded = loaded;

                if (!state.profile) {
                    updateProfileImages();
                    return;
                }

                if (cacheBust || typeof state.profileImageVersion !== 'number') {
                    state.profileImageVersion = Date.now();
                }

                updateProfileImages();
            }

            async function loadCurrentUserProfile({ force = false } = {}) {
                if (state.profileLoading) {
                    return state.profile;
                }
                if (state.profileLoaded && !force) {
                    updateProfileImages();
                    return state.profile;
                }

                state.profileLoading = true;
                try {
                    const data = await fetchJSON('/api/profile/');
                    setProfileData(data || null, { cacheBust: true, loaded: true });
                    return state.profile;
                } catch (error) {
                    console.error('Error loading profile:', error);
                    setProfileData(null, { loaded: false });
                    return null;
                } finally {
                    state.profileLoading = false;
                }
            }

            function updateNotificationsBadge() {
                if (!notificationsBadge) {
                    return;
                }
                const list = Array.isArray(state.notifications) ? state.notifications : [];
                const unreadCount = list.reduce((sum, item) => sum + (item && !item.is_read ? 1 : 0), 0);
                if (unreadCount > 0) {
                    notificationsBadge.textContent = unreadCount > 99
                        ? '99+'
                        : unreadCount.toLocaleString('fa-IR');
                    notificationsBadge.classList.remove('hidden');
                } else {
                    notificationsBadge.textContent = '';
                    notificationsBadge.classList.add('hidden');
                }
            }

            function renderNotificationsList() {
                if (!notificationsListContainer) {
                    return;
                }
                const notifications = Array.isArray(state.notifications) ? state.notifications : [];
                notificationsListContainer.innerHTML = '';

                if (notificationsError) {
                    const message = state.notificationsError;
                    if (message) {
                        notificationsError.textContent = message;
                        notificationsError.classList.remove('hidden');
                    } else {
                        notificationsError.textContent = '';
                        notificationsError.classList.add('hidden');
                    }
                }

                if (!notifications.length) {
                    if (notificationsEmpty) {
                        if (state.notificationsError) {
                            notificationsEmpty.classList.add('hidden');
                        } else {
                            notificationsEmpty.classList.remove('hidden');
                        }
                    }
                    return;
                }

                if (notificationsEmpty) {
                    notificationsEmpty.classList.add('hidden');
                }

                notifications.forEach(item => {
                    const wrapper = document.createElement('div');
                    const isRead = Boolean(item && item.is_read);
                    wrapper.className = `rounded-xl border p-4 space-y-2 transition ${isRead ? 'bg-white border-gray-200' : 'bg-indigo-50 border-indigo-100'}`;

                    const senderName = escapeHtml(item?.sender_name || 'Ø§Ø¯Ù…ÛŒÙ†');
                    const createdLabel = item?.created_at ? escapeHtml(formatToJalaliDateTime(item.created_at)) : '';
                    const messageText = escapeHtml(item?.message || '');

                    const channelBadges = [];
                    if (item?.channels?.panel) {
                        channelBadges.push('<span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-700">Ù¾Ù†Ù„</span>');
                    }
                    if (item?.channels?.telegram) {
                        const success = Boolean(item.telegram_sent);
                        const badgeClass = success ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
                        const label = success ? 'ØªÙ„Ú¯Ø±Ø§Ù…' : 'ØªÙ„Ú¯Ø±Ø§Ù… (Ù†Ø§Ù…ÙˆÙÙ‚)';
                        channelBadges.push(`<span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full ${badgeClass}">${label}</span>`);
                    }
                    if (item?.channels?.sms) {
                        const success = Boolean(item.sms_sent);
                        const badgeClass = success ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
                        const label = success ? 'Ù¾ÛŒØ§Ù…Ú©' : 'Ù¾ÛŒØ§Ù…Ú© (Ù†Ø§Ù…ÙˆÙÙ‚)';
                        channelBadges.push(`<span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full ${badgeClass}">${label}</span>`);
                    }

                    const errorItems = [];
                    if (item?.telegram_error) {
                        errorItems.push(`<li>ØªÙ„Ú¯Ø±Ø§Ù…: ${escapeHtml(item.telegram_error)}</li>`);
                    }
                    if (item?.sms_error) {
                        errorItems.push(`<li>Ù¾ÛŒØ§Ù…Ú©: ${escapeHtml(item.sms_error)}</li>`);
                    }

                    wrapper.innerHTML = `
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <p class="font-semibold text-gray-800">${senderName}</p>
                                <p class="text-sm text-gray-700 whitespace-pre-line">${messageText}</p>
                            </div>
                            ${createdLabel ? `<span class="text-xs text-gray-500">${createdLabel}</span>` : ''}
                        </div>
                        ${channelBadges.length ? `<div class="flex flex-wrap gap-2">${channelBadges.join('')}</div>` : ''}
                        ${errorItems.length ? `<ul class="text-xs text-red-600 list-disc pr-5 space-y-1">${errorItems.join('')}</ul>` : ''}
                    `;

                    notificationsListContainer.appendChild(wrapper);
                });
            }

            async function loadNotifications({ force = false } = {}) {
                if (state.notificationLoading) {
                    return state.notifications;
                }
                if (state.notificationsLoaded && !force) {
                    return state.notifications;
                }

                state.notificationLoading = true;
                if (notificationsLoading) {
                    notificationsLoading.classList.remove('hidden');
                }
                if (notificationsError) {
                    notificationsError.classList.add('hidden');
                    notificationsError.textContent = '';
                }

                try {
                    const data = await fetchJSON('/api/notifications/inbox/');
                    const normalized = Array.isArray(data) ? data.slice() : [];
                    const toTimestamp = (value) => {
                        const date = value ? new Date(value) : null;
                        return date && !Number.isNaN(date.getTime()) ? date.getTime() : 0;
                    };
                    normalized.sort((a, b) => toTimestamp(b?.created_at) - toTimestamp(a?.created_at));
                    state.notifications = normalized;
                    state.notificationsError = null;
                } catch (error) {
                    state.notificationsError = error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§.';
                    throw error;
                } finally {
                    state.notificationLoading = false;
                    state.notificationsLoaded = true;
                    if (notificationsLoading) {
                        notificationsLoading.classList.add('hidden');
                    }
                    renderNotificationsList();
                    updateNotificationsBadge();
                }

                return state.notifications;
            }

            async function markNotificationsAsRead(ids = []) {
                const cleanedIds = (Array.isArray(ids) ? ids : [ids])
                    .map(id => Number(id))
                    .filter(id => Number.isInteger(id));

                if (!cleanedIds.length) {
                    return;
                }

                try {
                    await fetchJSON('/api/notifications/mark-read/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ ids: cleanedIds }),
                    });
                    state.notifications = (state.notifications || []).map(item => {
                        if (!item) return item;
                        if (cleanedIds.includes(item.id)) {
                            return { ...item, is_read: true };
                        }
                        return item;
                    });
                    renderNotificationsList();
                    updateNotificationsBadge();
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                }
            }

            async function loadNotificationRecipients({ force = false } = {}) {
                if (!CURRENT_USER.isStaff) {
                    state.notificationRecipients = [];
                    state.notificationRecipientsLoaded = true;
                    state.notificationRecipientsError = null;
                    return state.notificationRecipients;
                }

                if (state.notificationRecipientsLoading) {
                    return state.notificationRecipients;
                }

                if (state.notificationRecipientsLoaded && !force && state.notificationRecipients.length) {
                    return state.notificationRecipients;
                }

                state.notificationRecipientsLoading = true;

                try {
                    const data = await fetchJSON('/api/notifications/recipients/');
                    const normalized = Array.isArray(data) ? data.slice() : [];
                    normalized.sort((a, b) => {
                        const nameA = (a?.full_name || '').trim();
                        const nameB = (b?.full_name || '').trim();
                        return nameA.localeCompare(nameB, 'fa');
                    });
                    state.notificationRecipients = normalized;
                    state.notificationRecipientsError = null;
                } catch (error) {
                    state.notificationRecipients = [];
                    state.notificationRecipientsError = error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø®Ø§Ø·Ø¨Ø§Ù†.';
                    throw error;
                } finally {
                    state.notificationRecipientsLoading = false;
                    state.notificationRecipientsLoaded = true;
                }

                return state.notificationRecipients;
            }

            function buildNotificationRecipientOptions(recipients = []) {
                if (!Array.isArray(recipients) || !recipients.length) {
                    return '';
                }
                const grouped = recipients.reduce((acc, item) => {
                    const roleKey = item?.role || 'other';
                    if (!acc[roleKey]) {
                        acc[roleKey] = [];
                    }
                    acc[roleKey].push(item);
                    return acc;
                }, {});

                const roleLabels = {
                    student: 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†',
                    advisor: 'Ù…Ø´Ø§ÙˆØ±Ø§Ù†',
                };
                const roleNames = {
                    student: 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²',
                    advisor: 'Ù…Ø´Ø§ÙˆØ±',
                };

                return Object.entries(grouped).map(([role, items]) => {
                    const label = roleLabels[role] || 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†';
                    const options = items.map(item => {
                        const value = Number(item?.user_id);
                        if (!Number.isInteger(value)) {
                            return '';
                        }
                        const parts = [];
                        if (item?.full_name) {
                            parts.push(item.full_name);
                        } else {
                            parts.push(`Ú©Ø§Ø±Ø¨Ø± ${value}`);
                        }
                        const roleName = roleNames[role];
                        if (roleName) {
                            parts.push(roleName);
                        }
                        if (item?.phone_number) {
                            parts.push(`Ø´Ù…Ø§Ø±Ù‡: ${item.phone_number}`);
                        }
                        const text = escapeHtml(parts.filter(Boolean).join(' â€¢ '));
                        return `<option value="${value}">${text}</option>`;
                    }).filter(Boolean).join('');
                    return `<optgroup label="${label}">${options}</optgroup>`;
                }).join('');
            }

            function initializeNotificationRecipientSelect(selectElement) {
                if (!selectElement) {
                    return;
                }
                if (notificationRecipientSelectInstance) {
                    notificationRecipientSelectInstance.destroy();
                    notificationRecipientSelectInstance = null;
                }
                notificationRecipientSelectInstance = new TomSelect(selectElement, {
                    persist: false,
                    plugins: ['remove_button'],
                    create: false,
                    maxOptions: 2000,
                    placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø®Ø§Ø·Ø¨Ø§Ù†',
                    render: {
                        option: (data, escape) => `<div class="text-sm">${escape(data.text)}</div>`,
                        item: (data, escape) => `<div class="text-sm">${escape(data.text)}</div>`,
                    },
                });
            }

            async function handleSendNotificationSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const feedback = document.getElementById('notification-form-feedback');

                if (feedback) {
                    feedback.textContent = '';
                    feedback.classList.add('hidden');
                    feedback.classList.remove('text-red-600', 'text-green-600', 'text-amber-600');
                }

                const selectedIds = notificationRecipientSelectInstance
                    ? notificationRecipientSelectInstance.getValue()
                    : Array.from(form.querySelectorAll('#notification-recipient-select option:checked')).map(option => option.value);
                const messageInput = form.querySelector('#notification-message');
                const message = (messageInput?.value || '').trim();
                const selectedChannels = Array.from(form.querySelectorAll('input[name="channels"]:checked')).map(input => input.value);

                if (!selectedIds.length) {
                    showToast('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }

                if (!message) {
                    showToast('Ù…ØªÙ† Ø§Ø¹Ù„Ø§Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.', 'error');
                    if (messageInput) {
                        messageInput.focus();
                    }
                    return;
                }

                if (!selectedChannels.length) {
                    showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù†Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.dataset.originalLabel = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }

                try {
                    const payload = {
                        message,
                        recipient_ids: selectedIds.map(id => Number(id)).filter(id => Number.isInteger(id)),
                        channels: selectedChannels,
                    };

                    const response = await fetchJSON('/api/notifications/send/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify(payload),
                    });

                    showToast('Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.', 'success');

                    if (feedback) {
                        const partialFailures = Array.isArray(response?.results)
                            ? response.results.flatMap(result => result.failed_channels || [])
                            : [];
                        if (partialFailures.length) {
                            const details = partialFailures
                                .map(item => `${item.channel}: ${item.reason || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`)
                                .join('ØŒ ');
                            feedback.textContent = `Ø¨Ø±Ø®ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ø®Ø·Ø§ Ø±ÙˆØ¨Ù‡â€ŒØ±Ùˆ Ø´Ø¯Ù†Ø¯: ${details}`;
                            feedback.classList.remove('hidden');
                            feedback.classList.add('text-amber-600');
                        } else {
                            feedback.textContent = 'Ø§Ø¹Ù„Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù…Ø®Ø§Ø·Ø¨Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.';
                            feedback.classList.remove('hidden');
                            feedback.classList.add('text-green-600');
                        }
                    }

                    form.reset();
                    if (notificationRecipientSelectInstance) {
                        notificationRecipientSelectInstance.clear(true);
                    }
                    const panelCheckbox = form.querySelector('input[name="channels"][value="panel"]');
                    if (panelCheckbox) {
                        panelCheckbox.checked = true;
                    }

                    try {
                        await loadNotifications({ force: true });
                    } catch (error) {
                        console.error('Error refreshing notifications after send:', error);
                    }
                } catch (error) {
                    const errorMessage = error.message || 'Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
                    showToast(errorMessage, 'error');
                    if (feedback) {
                        feedback.textContent = errorMessage;
                        feedback.classList.remove('hidden');
                        feedback.classList.add('text-red-600');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        if (submitBtn.dataset.originalLabel) {
                            submitBtn.innerHTML = submitBtn.dataset.originalLabel;
                            delete submitBtn.dataset.originalLabel;
                        }
                    }
                }
            }

            function startNotificationPolling() {
                if (notificationPollingInterval) {
                    return;
                }
                notificationPollingInterval = setInterval(() => {
                    loadNotifications({ force: true }).catch(error => {
                        console.error('Error polling notifications:', error);
                    });
                }, NOTIFICATION_POLL_INTERVAL);
            }

            function stopNotificationPolling() {
                if (notificationPollingInterval) {
                    clearInterval(notificationPollingInterval);
                    notificationPollingInterval = null;
                }
            }

            async function openNotificationsModal() {
                if (notificationsError) {
                    notificationsError.classList.add('hidden');
                    notificationsError.textContent = '';
                }
                try {
                    await loadNotifications({ force: true });
                } catch (error) {
                    // Ø®Ø·Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ state Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                } finally {
                    openModal('notifications-modal');
                    const unreadIds = (state.notifications || [])
                        .filter(item => item && !item.is_read)
                        .map(item => item.id);
                    if (unreadIds.length) {
                        await markNotificationsAsRead(unreadIds);
                    }
                }
            }

            const extractFileName = (path) => {
                if (!path) return '';
                const parts = path.split('/');
                return parts[parts.length - 1] || path;
            };

            const transformCourse = (course) => {
                const sessions = (course.sessions || []).map(session => ({
                    id: session.id,
                    number: session.session_number,
                    date: formatToJalali(session.date),
                    completed: session.is_completed,
                    rawDate: session.date,
                    videoUrl: session.video_url,
                }));
                const comments = (course.comments || []).map(comment => {
                    const attachmentUrl = comment.attachment;
                    const voiceUrl = comment.voice_note;
                    const authorName = comment.author?.full_name
                        || `${comment.author?.first_name || ''} ${comment.author?.last_name || ''}`.trim();
                    return {
                        id: comment.id,
                        authorName: authorName || 'Ú©Ø§Ø±Ø¨Ø±',
                        text: comment.text,
                        createdAt: comment.created_at,
                        attachmentUrl,
                        attachmentName: attachmentUrl ? extractFileName(attachmentUrl) : '',
                        voiceNoteUrl: voiceUrl,
                        voiceNoteName: voiceUrl ? extractFileName(voiceUrl) || 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØµÙˆØªÛŒ' : '',
                    };
                });
                const attachments = [];
                comments.forEach(comment => {
                    if (comment.attachmentUrl) {
                        attachments.push({
                            id: `file-${comment.id}`,
                            name: comment.attachmentName || 'ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª',
                            url: comment.attachmentUrl,
                            type: 'file',
                        });
                    }
                    if (comment.voiceNoteUrl) {
                        attachments.push({
                            id: `voice-${comment.id}`,
                            name: comment.voiceNoteName || 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØµÙˆØªÛŒ',
                            url: comment.voiceNoteUrl,
                            type: 'audio',
                        });
                    }
                });

                return {
                    id: course.id,
                    studentId: course.student,
                    advisorId: course.advisor,
                    studentName: course.student_name || '---',
                    advisorName: course.advisor_name || '---',
                    dayOfWeek: EN_TO_FA_DAYS[course.day_of_week] || course.day_of_week,
                    startTime: course.start_time,
                    time: course.start_time ? course.start_time.slice(0, 5) : '',
                    startDate: course.start_date,
                    startDateJalali: formatToJalali(course.start_date),
                    isActive: course.is_active,
                    classLink: course.class_link,
                    sessions,
                    comments,
                    attachments,
                };
            };

            function updateCourseInState(course) {
                if (!course || typeof course.id === 'undefined') {
                    return null;
                }
                const index = state.courses.findIndex(item => item && item.id === course.id);
                if (index >= 0) {
                    state.courses[index] = course;
                } else {
                    state.courses.push(course);
                }
                return course;
            }

            async function refreshCourse(courseId, options = {}) {
                const { reRenderModal = false, suppressErrorToast = false } = options;
                if (!courseId) {
                    return null;
                }
                try {
                    const data = await fetchJSON(`/courses/${courseId}/`);
                    const transformed = transformCourse(data);
                    updateCourseInState(transformed);
                    renderCalendar();
                    if (reRenderModal && activeCourseId === courseId) {
                        renderCourseDetails(transformed);
                    }
                    return transformed;
                } catch (error) {
                    console.error('Error refreshing course:', error);
                    if (!suppressErrorToast) {
                        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÙˆØ±Ù‡.', 'error');
                    }
                    return null;
                }
            }

            async function handleSessionToggle(sessionId, nextValue, checkboxEl, courseId) {
                if (!sessionId) {
                    return;
                }
                try {
                    const response = await fetch(`/sessions/${sessionId}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ is_completed: nextValue }),
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    showToast('ÙˆØ¶Ø¹ÛŒØª Ø¬Ù„Ø³Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                    await refreshCourse(courseId, { reRenderModal: true, suppressErrorToast: true });
                } catch (error) {
                    console.error('Error updating session status:', error);
                    showToast('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¬Ù„Ø³Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
                    if (checkboxEl) {
                        checkboxEl.checked = !nextValue;
                    }
                } finally {
                    if (checkboxEl) {
                        checkboxEl.disabled = false;
                    }
                }
            }

            async function submitCourseComment(courseId, formEl) {
                if (!formEl) {
                    return;
                }
                const submitBtn = formEl.querySelector('button[type="submit"]');
                const textField = formEl.querySelector('textarea[name="text"]');
                const fileInput = formEl.querySelector('input[name="attachment"]');
                const trimmedText = textField ? textField.value.trim() : '';
                const hasFile = !!(fileInput && fileInput.files && fileInput.files.length);
                if (!trimmedText && !hasFile) {
                    showToast('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù†Ø¸Ø± ÛŒØ§ ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                }

                try {
                    const formData = new FormData(formEl);
                    if (!trimmedText && hasFile) {
                        formData.set('text', 'Ù¾ÛŒÙˆØ³Øª Ø¬Ø¯ÛŒØ¯');
                    }
                    const response = await fetch(`/courses/${courseId}/add-comment/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken },
                        body: formData,
                    });
                    if (!response.ok) {
                        let message = 'Ø«Ø¨Øª Ù†Ø¸Ø± Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
                        try {
                            const errorPayload = await response.json();
                            if (errorPayload) {
                                const values = Object.values(errorPayload).flat().filter(Boolean);
                                if (values.length) {
                                    message = values.join('ØŒ ');
                                }
                            }
                        } catch (parseError) {
                            // ignore parse error
                        }
                        throw new Error(message);
                    }
                    showToast('Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.', 'success');
                    formEl.reset();
                    const fileNameHolder = formEl.querySelector('[data-file-name]');
                    if (fileNameHolder) {
                        fileNameHolder.textContent = '';
                    }
                    await refreshCourse(courseId, { reRenderModal: true });
                } catch (error) {
                    console.error('Error submitting comment:', error);
                    showToast(error.message || 'Ø«Ø¨Øª Ù†Ø¸Ø± Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.', 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                }
            }

            async function submitClassLink(courseId, formEl) {
                if (!formEl) {
                    return;
                }
                const input = formEl.querySelector('#course-class-link-input');
                const submitBtn = formEl.querySelector('button[type="submit"]');
                const rawValue = input ? input.value.trim() : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                try {
                    const response = await fetch(`/courses/${courseId}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({ class_link: rawValue || null }),
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    showToast(rawValue ? 'Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.' : 'Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø³ Ø­Ø°Ù Ø´Ø¯.', 'success');
                    await refreshCourse(courseId, { reRenderModal: true });
                } catch (error) {
                    console.error('Error saving class link:', error);
                    showToast('Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø³ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.', 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                }
            }

            function bindCourseDetailsEvents(course) {
                const modalContentContainer = document.getElementById('course-details-content');
                if (!modalContentContainer) {
                    return;
                }

                const commentForm = modalContentContainer.querySelector('#course-comment-form');
                if (commentForm) {
                    const attachmentInput = commentForm.querySelector('input[name="attachment"]');
                    const fileNameHolder = commentForm.querySelector('[data-file-name]');
                    if (attachmentInput && fileNameHolder) {
                        attachmentInput.addEventListener('change', () => {
                            const file = attachmentInput.files && attachmentInput.files[0];
                            fileNameHolder.textContent = file ? `ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: ${file.name}` : '';
                        });
                    }
                    commentForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        submitCourseComment(course.id, commentForm);
                    });
                }

                const classLinkForm = modalContentContainer.querySelector('#course-class-link-form');
                if (classLinkForm) {
                    classLinkForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        submitClassLink(course.id, classLinkForm);
                    });
                }

                const sessionToggles = modalContentContainer.querySelectorAll('[data-session-toggle]');
                sessionToggles.forEach(toggle => {
                    toggle.addEventListener('change', (event) => {
                        const input = event.target;
                        const sessionId = Number(input.dataset.sessionId);
                        input.disabled = true;
                        handleSessionToggle(sessionId, input.checked, input, course.id);
                    });
                });
            }

            function renderCourseDetails(course) {
                const modalContentContainer = document.getElementById('course-details-content');
                if (!modalContentContainer) {
                    return;
                }

                if (!course) {
                    modalContentContainer.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-3xl modal-enter">
                            <div class="p-6 text-center text-sm text-gray-500">
                                Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ÙØª Ù†Ø´Ø¯.
                            </div>
                        </div>
                    `;
                    return;
                }

                const canToggleSessions = currentRole === 'counselor';
                const canEditClassLink = currentRole === 'admin' || currentRole === 'counselor';
                const sessions = Array.isArray(course.sessions) ? course.sessions : [];
                const comments = Array.isArray(course.comments) ? course.comments : [];
                const attachments = Array.isArray(course.attachments) ? course.attachments : [];
                const canSubmitComment = ['admin', 'counselor', 'student'].includes(currentRole);

                const sessionItemsHtml = sessions.length
                    ? sessions.map(session => {
                        const sessionNumber = escapeHtml(String(session.number || ''));
                        const sessionDate = session.date ? escapeHtml(session.date) : '---';
                        const statusClass = session.completed ? 'text-green-600' : 'text-gray-500';
                        const statusLabel = session.completed ? 'Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´Ø¯' : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                        const toggleHtml = canToggleSessions
                            ? `
                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" data-session-toggle data-session-id="${session.id}" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${session.completed ? 'checked' : ''}>
                                    <span>ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ú¯Ø²Ø§Ø±ÛŒ</span>
                                </label>
                            `
                            : `<span class="text-xs ${statusClass}">${statusLabel}</span>`;
                        return `
                            <div class="flex items-center justify-between bg-indigo-50 rounded-lg p-3" data-session-id="${session.id}">
                                <div>
                                    <p class="font-semibold text-gray-800">Ø¬Ù„Ø³Ù‡ ${sessionNumber}</p>
                                    <p class="text-xs text-gray-500">${sessionDate}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    ${toggleHtml}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-sm text-gray-500">Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';

                const commentsHtml = comments.length
                    ? comments.map(comment => {
                        const author = escapeHtml(comment.authorName || 'Ú©Ø§Ø±Ø¨Ø±');
                        const createdAt = comment.createdAt ? escapeHtml(formatToJalaliDateTime(comment.createdAt)) : '';
                        const commentBody = escapeHtml(comment.text || '').replace(/\n/g, '<br>');
                        const attachmentsParts = [];
                        if (comment.attachmentUrl) {
                            attachmentsParts.push(`
                                <a href="${escapeHtml(comment.attachmentUrl)}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-700">
                                    <i class="fas fa-paperclip"></i>
                                    <span>${escapeHtml(comment.attachmentName || 'ÙØ§ÛŒÙ„ Ù¾ÛŒÙˆØ³Øª')}</span>
                                </a>
                            `);
                        }
                        if (comment.voiceNoteUrl) {
                            attachmentsParts.push(`
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <i class="fas fa-microphone text-indigo-500"></i>
                                    <audio controls class="w-full" src="${escapeHtml(comment.voiceNoteUrl)}"></audio>
                                </div>
                            `);
                        }
                        const attachmentsBlock = attachmentsParts.length
                            ? `<div class="mt-3 space-y-2">${attachmentsParts.join('')}</div>`
                            : '';
                        return `
                            <article class="p-3 bg-white rounded-lg border border-indigo-100 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="font-semibold text-gray-700">${author}</p>
                                    <span class="text-xs text-gray-400">${createdAt}</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-6 whitespace-pre-wrap">${commentBody || 'Ø¨Ø¯ÙˆÙ† Ù…ØªÙ†'}</p>
                                ${attachmentsBlock}
                            </article>
                        `;
                    }).join('')
                    : '<p class="text-xs text-gray-400">Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';

                const attachmentsHtml = attachments.length
                    ? attachments.map(item => {
                        if (item.type === 'audio') {
                            return `
                                <div class="p-2 border rounded-lg flex items-center gap-3 bg-white">
                                    <i class="fas fa-microphone text-indigo-500"></i>
                                    <audio controls class="flex-1" src="${escapeHtml(item.url)}"></audio>
                                </div>
                            `;
                        }
                        return `
                            <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 p-2 border rounded-lg bg-white hover:bg-indigo-50 text-sm text-gray-700">
                                <i class="fas fa-paperclip text-indigo-500"></i>
                                <span>${escapeHtml(item.name || 'Ù¾ÛŒÙˆØ³Øª')}</span>
                            </a>
                        `;
                    }).join('')
                    : '<p class="text-xs text-gray-400">ÙØ§ÛŒÙ„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';

                const classLinkSection = canEditClassLink
                    ? `
                        <form id="course-class-link-form" class="space-y-3">
                            <div class="space-y-1">
                                <label for="course-class-link-input" class="text-sm font-semibold text-gray-700">Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø³ Ø¢Ù†Ù„Ø§ÛŒÙ†</label>
                                <input id="course-class-link-input" name="class_link" type="url" value="${course.classLink ? escapeHtml(course.classLink) : ''}" placeholder="https://example.com/class" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                                <p class="text-xs text-gray-400">Ø¯Ø± ØµÙˆØ±Øª Ø®Ø§Ù„ÛŒ Ú¯Ø°Ø§Ø´ØªÙ†ØŒ Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-3">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©</button>
                                ${course.classLink ? `<a href="${escapeHtml(course.classLink)}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-white border border-indigo-200 text-indigo-600 rounded-lg hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-external-link"></i><span>Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©</span></a>` : ''}
                            </div>
                        </form>
                    `
                    : (course.classLink
                        ? `<a href="${escapeHtml(course.classLink)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 hover:bg-indigo-100"><i class="fas fa-link"></i><span>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ù„Ø§Ø³</span></a>`
                        : '<p class="text-xs text-gray-400">Ù„ÛŒÙ†Ú©ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>');

                const commentFormHtml = canSubmitComment ? `
                    <form id="course-comment-form" class="space-y-3 bg-indigo-50 border border-indigo-100 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-semibold text-gray-700">Ø«Ø¨Øª Ù†Ø¸Ø± Ø¬Ø¯ÛŒØ¯</label>
                        </div>
                        <textarea name="text" rows="3" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ù†Ø¸Ø± ÛŒØ§ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                            <label class="flex items-center gap-2 cursor-pointer text-indigo-600">
                                <i class="fas fa-paperclip"></i>
                                <span>Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„</span>
                                <input type="file" name="attachment" class="hidden">
                            </label>
                            <span data-file-name class="text-xs text-gray-500"></span>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ø«Ø¨Øª Ù†Ø¸Ø±</button>
                        </div>
                    </form>
                ` : '';

                modalContentContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-3xl flex flex-col modal-enter">
                        <div class="p-4 border-b flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-lg font-bold text-gray-800">${escapeHtml(course.studentName)}</h2>
                                <div class="text-xs text-gray-500 flex flex-wrap items-center gap-3">
                                    <span class="inline-flex items-center gap-1"><i class="fas fa-user-tie text-indigo-500"></i>${escapeHtml(course.advisorName)}</span>
                                    <span class="inline-flex items-center gap-1"><i class="fas fa-calendar-day text-indigo-500"></i>${escapeHtml(course.dayOfWeek || '---')}</span>
                                    <span class="inline-flex items-center gap-1"><i class="fas fa-clock text-indigo-500"></i>${escapeHtml(course.time || '---')}</span>
                                </div>
                            </div>
                            <button data-close-modal="course-details-modal" class="self-start sm:self-center px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¨Ø³ØªÙ†</button>
                        </div>
                        <div class="p-4 space-y-6 overflow-y-auto max-h-[70vh]">
                            <section class="space-y-3">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-sm sm:text-base"><i class="fas fa-clock text-indigo-500"></i>Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ù„Ø³Ø§Øª</h3>
                                <div class="space-y-2">${sessionItemsHtml}</div>
                                ${canToggleSessions ? '<p class="text-xs text-gray-400">ØªÙ†Ù‡Ø§ Ù…Ø´Ø§ÙˆØ± Ù‚Ø§Ø¯Ø± Ø¨Ù‡ ØªÛŒÚ© Ø²Ø¯Ù† Ø¬Ù„Ø³Ø§Øª Ø§Ø³Øª.</p>' : ''}
                            </section>
                            <section class="space-y-3">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-sm sm:text-base"><i class="fas fa-link text-indigo-500"></i>Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø³</h3>
                                ${classLinkSection}
                            </section>
                            <section class="space-y-3">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-sm sm:text-base"><i class="fas fa-comment-dots text-indigo-500"></i>Ù†Ø¸Ø±Ø§Øª</h3>
                                <div class="space-y-3">${commentsHtml}</div>
                                ${commentFormHtml}
                            </section>
                            <section class="space-y-3">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-sm sm:text-base"><i class="fas fa-folder-open text-indigo-500"></i>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§</h3>
                                <div class="space-y-2">${attachmentsHtml}</div>
                            </section>
                        </div>
                    </div>
                `;

                bindCourseDetailsEvents(course);
            }

            async function loadCourses() {
                try {
                    const courses = await fetchJSON('/courses/');
                    state.courses = courses.map(transformCourse);
                } catch (error) {
                    console.error('Error loading courses:', error);
                    state.courses = [];
                }
            }

            async function loadAdvisors() {
                if (!CURRENT_USER.isStaff) {
                    state.advisors = [];
                    state.advisorsLoaded = true;
                    return;
                }

                try {
                    const advisors = await fetchJSON('/api/advisors/');
                    state.advisors = Array.isArray(advisors) ? advisors : [];
                } catch (error) {
                    if (error?.status !== 403) {
                        console.error('Error loading advisors:', error);
                    }
                    state.advisors = [];
                } finally {
                    state.advisorsLoaded = true;
                }
            }

            function updateCounselorFilterOptions() {
                if (!counselorFilter) return;

                const previousRawValue = counselorSelectInstance
                    ? counselorSelectInstance.getValue()
                    : (counselorFilter.value || 'all');
                const previousValue = Array.isArray(previousRawValue)
                    ? (previousRawValue[0] || 'all')
                    : (previousRawValue || 'all');

                const options = ['<option value="all">Ù‡Ù…Ù‡</option>'];
                const advisorList = Array.isArray(state.advisors) ? state.advisors : [];

                advisorList
                    .slice()
                    .sort((a, b) => {
                        const nameA = (a.full_name || '').trim();
                        const nameB = (b.full_name || '').trim();
                        return nameA.localeCompare(nameB, 'fa');
                    })
                    .forEach(advisor => {
                        if (!advisor || typeof advisor.id === 'undefined') return;
                        const optionLabel = advisor.full_name || `Ù…Ø´Ø§ÙˆØ± ${advisor.id}`;
                        options.push(`<option value="${advisor.id}">${optionLabel}</option>`);
                    });

                counselorFilter.innerHTML = options.join('');

                const validIds = new Set(advisorList.map(advisor => String(advisor.id)));
                const normalizedPrev = String(previousValue || 'all');
                const nextValue = normalizedPrev !== 'all' && !validIds.has(normalizedPrev) ? 'all' : normalizedPrev;
                counselorFilter.value = nextValue;

                const shouldDisable = !(currentRole === 'admin' && CURRENT_USER.isStaff);
                setCounselorFilterDisabled(shouldDisable);
                initializeCounselorSelect(nextValue);
            }

            async function loadPayments() {
                if (!CURRENT_USER.isStaff) {
                    state.payments = [];
                    state.paymentsLoaded = true;
                    return;
                }
                try {
                    const payments = await fetchJSON('/api/payments/');
                    state.payments = payments;
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error loading payments:', error);
                    }
                    state.payments = [];
                } finally {
                    state.paymentsLoaded = true;
                }
            }

            async function loadReports(options = {}) {
                const { force = false } = options;
                const filters = ensureReportFilters();

                if (state.reportLoading) {
                    return state.reportData;
                }

                if (state.reportsLoaded && !force && state.reportData) {
                    return state.reportData;
                }

                state.reportLoading = true;
                try {
                    const params = new URLSearchParams();
                    if (filters.startDate) {
                        params.append('start_date', filters.startDate);
                    }
                    if (filters.endDate) {
                        params.append('end_date', filters.endDate);
                    }
                    if (filters.advisorId && filters.advisorId !== 'all') {
                        params.append('advisor_id', filters.advisorId);
                    }
                    const url = params.toString()
                        ? `/api/reports/summary/?${params.toString()}`
                        : '/api/reports/summary/';
                    const data = await fetchJSON(url);
                    state.reportData = data;
                    state.reportsLoaded = true;
                    return data;
                } catch (error) {
                    state.reportsLoaded = false;
                    throw error;
                } finally {
                    state.reportLoading = false;
                }
            }

            function showReportsLoading() {
                const container = document.getElementById('reports-results');
                if (!container) return;
                container.innerHTML = `
                    <div class="flex justify-center py-10">
                        <div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
                    </div>
                `;
            }

            function renderReportsError(message = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§.') {
                const container = document.getElementById('reports-results');
                if (!container) return;
                container.innerHTML = `<p class="text-sm text-red-500">${escapeHtml(message)}</p>`;
            }

            function renderReportSessionSection({ title, items, emptyMessage, includeTime = false }) {
                const dataset = Array.isArray(items) ? items : [];
                if (!title) {
                    return '';
                }

                const rows = dataset.map(item => {
                    const studentName = item?.student?.name ? escapeHtml(item.student.name) : '---';
                    const advisorName = item?.advisor?.name ? escapeHtml(item.advisor.name) : '---';
                    const sessionNumber = typeof item?.session_number === 'number'
                        ? formatCount(item.session_number)
                        : (item?.session_number ? formatCount(item.session_number) : '---');
                    const dateLabel = item?.date ? formatToJalaliShort(item.date) : '---';
                    const dayLabelRaw = item?.day_of_week ? (EN_TO_FA_DAYS[item.day_of_week] || item.day_of_week) : '---';
                    const dayLabel = dayLabelRaw ? escapeHtml(dayLabelRaw) : '---';
                    const timeLabel = includeTime
                        ? (item?.start_time ? escapeHtml(String(item.start_time).slice(0, 5)) : '---')
                        : null;
                    const scheduleCell = includeTime ? `${dayLabel} - ${timeLabel}` : dayLabel;
                    return `
                        <tr class="border-b border-gray-100 text-sm text-gray-700">
                            <td class="px-4 py-2 whitespace-nowrap">${studentName}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${advisorName}</td>
                            <td class="px-4 py-2 text-center">${sessionNumber}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${dateLabel}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${scheduleCell}</td>
                        </tr>
                    `;
                }).join('');

                const body = dataset.length
                    ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="px-4 py-2 text-right font-semibold">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                                        <th class="px-4 py-2 text-right font-semibold">Ù…Ø´Ø§ÙˆØ±</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ø´Ù…Ø§Ø±Ù‡ Ø¬Ù„Ø³Ù‡</th>
                                        <th class="px-4 py-2 text-right font-semibold">ØªØ§Ø±ÛŒØ®</th>
                                        <th class="px-4 py-2 text-right font-semibold">${includeTime ? 'Ø±ÙˆØ² / Ø³Ø§Ø¹Øª' : 'Ø±ÙˆØ²'}</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    `
                    : `<p class="p-4 text-sm text-gray-500">${escapeHtml(emptyMessage || 'Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.')}</p>`;

                return `
                    <section class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                            <h4 class="font-semibold text-gray-800">${escapeHtml(title)}</h4>
                            <span class="text-sm text-gray-500">${formatCount(dataset.length)} Ù…ÙˆØ±Ø¯</span>
                        </div>
                        ${body}
                    </section>
                `;
            }

            function renderCompletionSection(items) {
                const dataset = Array.isArray(items) ? items : [];
                const total = dataset.reduce((sum, entry) => sum + (Number(entry?.count) || 0), 0);

                const rows = dataset.map(entry => {
                    const dateLabel = entry?.date ? formatToJalaliShort(entry.date) : '---';
                    const countLabel = formatCount(entry?.count || 0);
                    return `
                        <tr class="border-b border-gray-100 text-sm text-gray-700">
                            <td class="px-4 py-2 whitespace-nowrap">${dateLabel}</td>
                            <td class="px-4 py-2 text-center font-semibold">${countLabel}</td>
                        </tr>
                    `;
                }).join('');

                const table = dataset.length
                    ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="px-4 py-2 text-right font-semibold">ØªØ§Ø±ÛŒØ®</th>
                                        <th class="px-4 py-2 text-center font-semibold">ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØªÙ…Ø§Ù…â€ŒÛŒØ§ÙØªÙ‡</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                                <tfoot class="bg-gray-50 text-gray-700 font-semibold">
                                    <tr>
                                        <td class="px-4 py-2 text-right">Ù…Ø¬Ù…ÙˆØ¹</td>
                                        <td class="px-4 py-2 text-center">${formatCount(total)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `
                    : `<p class="p-4 text-sm text-gray-500">Ø¯ÙˆØ±Ù‡Ù” ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;

                return `
                    <section class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                            <h4 class="font-semibold text-gray-800">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø§ØªÙ…Ø§Ù… Ø¯ÙˆØ±Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø±ÙˆØ²</h4>
                            <span class="text-sm text-gray-500">${formatCount(total)} Ø¯ÙˆØ±Ù‡</span>
                        </div>
                        ${table}
                    </section>
                `;
            }

            function renderDistributionList(title, items) {
                const dataset = Array.isArray(items) ? items : [];
                if (!dataset.length) {
                    return `
                        <div class="bg-gray-50 border border-gray-100 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-700">${escapeHtml(title)}</h5>
                            <p class="mt-3 text-sm text-gray-500">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>
                        </div>
                    `;
                }

                const listItems = dataset.map(entry => {
                    const name = entry?.advisor_name || entry?.grade_name || entry?.major_name || '---';
                    return `
                        <li class="flex items-center justify-between">
                            <span class="text-gray-600">${escapeHtml(name)}</span>
                            <span class="font-semibold text-gray-800">${formatCount(entry?.count || 0)}</span>
                        </li>
                    `;
                }).join('');

                return `
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-700">${escapeHtml(title)}</h5>
                        <ul class="mt-3 space-y-2 text-sm">${listItems}</ul>
                    </div>
                `;
            }

            function renderDistributionSection(distribution = {}) {
                const cards = [
                    renderDistributionList('Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø´Ø§ÙˆØ±', distribution?.by_advisor),
                    renderDistributionList('Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù¾Ø§ÛŒÙ‡', distribution?.by_grade),
                    renderDistributionList('Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø±Ø´ØªÙ‡', distribution?.by_major),
                ].join('');

                return `
                    <section class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <h4 class="font-semibold text-gray-800">ØªÙˆØ²ÛŒØ¹ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h4>
                        </div>
                        <div class="grid gap-6 p-4 md:grid-cols-2 xl:grid-cols-3">
                            ${cards}
                        </div>
                    </section>
                `;
            }

            function renderAdvisorStatsSection({ sessionCounts = [], dropoutCounts = [], nonRenewCounts = [], chatStats = [] }) {
                const advisorMap = new Map();

                const register = (advisorId, advisorName) => {
                    if (!advisorId) {
                        return null;
                    }
                    if (!advisorMap.has(advisorId)) {
                        advisorMap.set(advisorId, {
                            advisorId,
                            advisorName: advisorName || '---',
                            sessions: 0,
                            dropouts: 0,
                            nonRenewals: 0,
                            answeredChats: 0,
                            unansweredChats: 0,
                        });
                    }
                    return advisorMap.get(advisorId);
                };

                sessionCounts.forEach(item => {
                    const record = register(item?.advisor_id, item?.advisor_name);
                    if (record) {
                        record.sessions = Number(item?.count || 0);
                    }
                });

                dropoutCounts.forEach(item => {
                    const record = register(item?.advisor_id, item?.advisor_name);
                    if (record) {
                        record.dropouts = Number(item?.count || 0);
                    }
                });

                nonRenewCounts.forEach(item => {
                    const record = register(item?.advisor_id, item?.advisor_name);
                    if (record) {
                        record.nonRenewals = Number(item?.count || 0);
                    }
                });

                chatStats.forEach(item => {
                    const record = register(item?.advisor_id, item?.advisor_name);
                    if (record) {
                        record.answeredChats = Number(item?.answered || 0);
                        record.unansweredChats = Number(item?.unanswered || 0);
                    }
                });

                const advisors = Array.from(advisorMap.values())
                    .sort((a, b) => (a.advisorName || '').localeCompare(b.advisorName || '', 'fa'));

                if (!advisors.length) {
                    return `
                        <section class="bg-white rounded-xl shadow-sm border border-gray-100">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <h4 class="font-semibold text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø´Ø§ÙˆØ±Ø§Ù†</h4>
                            </div>
                            <p class="p-4 text-sm text-gray-500">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                        </section>
                    `;
                }

                const rows = advisors.map(entry => `
                    <tr class="border-b border-gray-100 text-sm text-gray-700">
                        <td class="px-4 py-2 whitespace-nowrap">${escapeHtml(entry.advisorName)}</td>
                        <td class="px-4 py-2 text-center">${formatCount(entry.sessions)}</td>
                        <td class="px-4 py-2 text-center">${formatCount(entry.dropouts)}</td>
                        <td class="px-4 py-2 text-center">${formatCount(entry.nonRenewals)}</td>
                        <td class="px-4 py-2 text-center">${formatCount(entry.answeredChats)}</td>
                        <td class="px-4 py-2 text-center text-amber-600">${formatCount(entry.unansweredChats)}</td>
                    </tr>
                `).join('');

                return `
                    <section class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <h4 class="font-semibold text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø´Ø§ÙˆØ±Ø§Ù†</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="px-4 py-2 text-right font-semibold">Ù…Ø´Ø§ÙˆØ±</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ø¬Ù„Ø³Ø§Øª Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´Ø¯Ù‡</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø§Ù†ØµØ±Ø§ÙÛŒ</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ø¹Ø¯Ù… ØªÙ…Ø¯ÛŒØ¯ Ø¯ÙˆØ±Ù‡</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡</th>
                                        <th class="px-4 py-2 text-center font-semibold">Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ù¾Ø§Ø³Ø®</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </section>
                `;
            }

            function renderReportsData() {
                const container = document.getElementById('reports-results');
                if (!container) return;

                const data = state.reportData;
                if (!data) {
                    container.innerHTML = '<p class="text-sm text-gray-600">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                    return;
                }

                const {
                    filters = {},
                    overdue_sessions: overdueSessions = [],
                    course_completions_by_day: completionByDay = [],
                    sessions_without_plan: sessionsWithoutPlan = [],
                    advisor_session_counts: advisorSessionCounts = [],
                    advisor_dropout_counts: advisorDropoutCounts = [],
                    advisor_non_renewal_counts: advisorNonRenewCounts = [],
                    student_distribution: studentDistribution = {},
                    advisor_chat_stats: advisorChatStats = [],
                } = data;

                const startLabel = filters?.start_date ? formatToJalaliShort(filters.start_date) : '---';
                const endLabel = filters?.end_date ? formatToJalaliShort(filters.end_date) : '---';

                const filterSummary = `
                    <div class="bg-indigo-50 border border-indigo-200 text-indigo-700 rounded-lg px-4 py-3 text-sm flex flex-wrap items-center gap-2">
                        <span>Ø¨Ø§Ø²Ù‡ Ú¯Ø²Ø§Ø±Ø´:</span>
                        <span class="font-semibold">${startLabel}</span>
                        <span>ØªØ§</span>
                        <span class="font-semibold">${endLabel}</span>
                    </div>
                `;

                const overdueSection = renderReportSessionSection({
                    title: 'Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† ØªÛŒÚ©',
                    items: overdueSessions,
                    emptyMessage: 'Ù‡Ù…Ù‡ Ø¬Ù„Ø³Ø§Øª Ø§Ù…Ø±ÙˆØ² ÙˆØ¶Ø¹ÛŒØª Ø«Ø¨Øª Ø¯Ø§Ø±Ù†Ø¯.',
                    includeTime: true,
                });

                const completionsSection = renderCompletionSection(completionByDay);

                const sessionsWithoutPlanSection = renderReportSessionSection({
                    title: 'Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡',
                    items: sessionsWithoutPlan,
                    emptyMessage: 'Ù‡Ù…Ù‡ Ø¬Ù„Ø³Ø§Øª ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡ Ø¯Ø§Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡Ø³ØªÙ†Ø¯.',
                });

                const advisorStatsSection = renderAdvisorStatsSection({
                    sessionCounts: advisorSessionCounts,
                    dropoutCounts: advisorDropoutCounts,
                    nonRenewCounts: advisorNonRenewCounts,
                    chatStats: advisorChatStats,
                });

                const distributionSection = renderDistributionSection(studentDistribution);

                container.innerHTML = [
                    filterSummary,
                    overdueSection,
                    completionsSection,
                    sessionsWithoutPlanSection,
                    advisorStatsSection,
                    distributionSection,
                ].join('');
            }

            function setupJalaliDatePicker(displayInput, hiddenInput, initialValue) {
                if (!displayInput) {
                    return;
                }

                const hasPersianPicker = typeof window.$ === 'function'
                    && window.$.fn
                    && typeof window.$.fn.persianDatepicker === 'function'
                    && typeof window.persianDate === 'function';

                if (hasPersianPicker && hiddenInput) {
                    displayInput.setAttribute('readonly', 'readonly');
                    window.$(displayInput).persianDatepicker({
                        calendar: {
                            persian: { locale: 'fa', leapYearMode: 'algorithmic' },
                            gregorian: { locale: 'en', leapYearMode: 'algorithmic' },
                        },
                        format: 'YYYY/MM/DD',
                        altField: `#${hiddenInput.id}`,
                        altFormat: 'YYYY-MM-DD',
                        initialValue: false,
                        autoClose: true,
                        toolbox: { calendarSwitch: { enabled: false } },
                        navigator: { scroll: { enabled: false } },
                        onSelect: (unix) => {
                            if (typeof window.persianDate === 'function') {
                                try {
                                    const persianDateInstance = new window.persianDate(unix);
                                    displayInput.value = persianDateInstance.format('YYYY/MM/DD');
                                    hiddenInput.value = persianDateInstance.toCalendar('gregorian').format('YYYY-MM-DD');
                                } catch (error) {
                                    hiddenInput.value = '';
                                }
                            }
                        },
                    });

                    if (initialValue) {
                        try {
                            const persian = new window.persianDate(initialValue);
                            displayInput.value = persian.format('YYYY/MM/DD');
                            hiddenInput.value = persian.toCalendar('gregorian').format('YYYY-MM-DD');
                            window.$(displayInput).persianDatepicker('setDate', persian);
                        } catch (error) {
                            hiddenInput.value = initialValue;
                        }
                    }
                } else {
                    displayInput.removeAttribute('readonly');
                    displayInput.setAttribute('type', 'date');
                    if (hiddenInput) {
                        if (initialValue) {
                            displayInput.value = initialValue;
                            hiddenInput.value = initialValue;
                        }
                        displayInput.addEventListener('change', () => {
                            hiddenInput.value = toEnglishDigits(displayInput.value || '');
                        });
                    }
                }

                displayInput.addEventListener('input', () => {
                    if (hiddenInput && !hiddenInput.value) {
                        const normalized = toEnglishDigits(displayInput.value || '');
                        hiddenInput.value = normalized.replace(/\//g, '-');
                    }
                });
            }

            async function setupReportsView() {
                const filters = ensureReportFilters();

                const startDisplay = document.getElementById('report-start-display');
                const startHidden = document.getElementById('report-start-hidden');
                const endDisplay = document.getElementById('report-end-display');
                const endHidden = document.getElementById('report-end-hidden');
                const advisorSelect = document.getElementById('report-advisor-select');
                const filterForm = document.getElementById('reports-filter-form');
                const refreshBtn = document.getElementById('reports-refresh-btn');

                if (startHidden) startHidden.value = filters.startDate || '';
                if (endHidden) endHidden.value = filters.endDate || '';

                if (startDisplay) {
                    startDisplay.value = filters.startDate ? formatToJalaliShort(filters.startDate) : '';
                }
                if (endDisplay) {
                    endDisplay.value = filters.endDate ? formatToJalaliShort(filters.endDate) : '';
                }
                if (advisorSelect) {
                    const advisorValue = filters.advisorId && filters.advisorId !== 'all'
                        ? String(filters.advisorId)
                        : 'all';
                    advisorSelect.value = advisorValue;
                }

                setupJalaliDatePicker(startDisplay, startHidden, filters.startDate);
                setupJalaliDatePicker(endDisplay, endHidden, filters.endDate);

                if (!state.reportsLoaded || !state.reportData) {
                    showReportsLoading();
                    try {
                        await loadReports();
                        renderReportsData();
                    } catch (error) {
                        console.error('Error loading reports:', error);
                        renderReportsError(error?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§.');
                    }
                } else {
                    renderReportsData();
                }

                if (filterForm) {
                    filterForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const advisorValue = advisorSelect ? advisorSelect.value : 'all';
                        const nextStart = startHidden ? toEnglishDigits(startHidden.value || '') : '';
                        const nextEnd = endHidden ? toEnglishDigits(endHidden.value || '') : '';

                        state.reportFilters = {
                            startDate: nextStart || null,
                            endDate: nextEnd || null,
                            advisorId: advisorValue && advisorValue !== 'all' ? advisorValue : 'all',
                        };

                        showReportsLoading();
                        if (refreshBtn) {
                            refreshBtn.disabled = true;
                            refreshBtn.classList.add('opacity-70');
                        }
                        try {
                            await loadReports({ force: true });
                            renderReportsData();
                            showToast('Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                        } catch (error) {
                            console.error('Error refreshing reports:', error);
                            renderReportsError(error?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§.');
                        } finally {
                            if (refreshBtn) {
                                refreshBtn.disabled = false;
                                refreshBtn.classList.remove('opacity-70');
                            }
                        }
                    });
                }
            }

            async function updatePaymentStatus(paymentId, action, body = null) {
                if (!paymentId || !action) {
                    return;
                }
                const payload = body ? JSON.stringify(body) : JSON.stringify({});
                return fetchJSON(`/api/payments/${paymentId}/${action}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: payload,
                });
            }

            function renderStudentPaymentHistory() {
                if (!studentPaymentHistoryContainer) return;

                if (!state.studentPayments.length) {
                    studentPaymentHistoryContainer.innerHTML = `
                        <div class="bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 text-sm text-gray-500 text-center">
                            Ù‡Ù†ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
                        </div>
                    `;
                    return;
                }

                const statusLabels = {
                    pending: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
                    approved: 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                    rejected: 'Ø±Ø¯ Ø´Ø¯Ù‡',
                };
                const statusClassMap = {
                    pending: 'text-amber-500',
                    approved: 'text-green-600',
                    rejected: 'text-red-500',
                };

                const items = state.studentPayments.map(payment => {
                    const statusKey = payment.status || 'pending';
                    const statusText = payment.status_display || statusLabels[statusKey] || statusKey;
                    const statusClass = statusClassMap[statusKey] || 'text-gray-600';
                    const amount = Number(payment.amount || 0).toLocaleString('fa-IR');
                    const adminNotes = payment.admin_notes ? `<p class="text-xs text-gray-500 mt-2 leading-5">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø¯Ù…ÛŒÙ†: ${payment.admin_notes}</p>` : '';
                    return `
                        <div class="bg-indigo-50 rounded-lg p-3 mb-3 shadow-sm border border-indigo-100 last:mb-0">
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-700">Ù…Ø¨Ù„Øº: ${amount} ØªÙˆÙ…Ø§Ù†</span>
                                <span class="text-xs text-gray-500">${formatToJalali(payment.payment_date)}</span>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-sm">
                                <span class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: ${payment.reference_number}</span>
                                <span class="font-semibold ${statusClass}">${statusText}</span>
                            </div>
                            ${adminNotes}
                        </div>
                    `;
                }).join('');

                studentPaymentHistoryContainer.innerHTML = `
                    <h3 class="text-base font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-receipt text-indigo-500"></i>
                        <span>Ø³ÙˆØ§Ø¨Ù‚ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§</span>
                    </h3>
                    ${items}
                `;
            }

            async function loadStudentPayments({ notify = true } = {}) {
                if (CURRENT_USER.role !== 'student') {
                    state.studentPayments = [];
                    state.studentPaymentsLoaded = true;
                    if (studentPaymentHistoryContainer) {
                        studentPaymentHistoryContainer.innerHTML = '';
                    }
                    return [];
                }

                try {
                    const payments = await fetchJSON('/api/payments/mine/');
                    const normalized = Array.isArray(payments) ? payments : [];
                    const previousStatuses = new Map(state.studentPayments.map(payment => [payment.id, payment.status]));

                    if (state.studentPaymentsLoaded && notify) {
                        normalized.forEach(payment => {
                            const previousStatus = previousStatuses.get(payment.id);
                            if (previousStatus && previousStatus === payment.status) {
                                return;
                            }
                            if (!previousStatus && payment.status === 'pending') {
                                return;
                            }
                            if (payment.status === 'approved') {
                                showToast('Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.', 'success');
                            } else if (payment.status === 'rejected') {
                                const reason = payment.admin_notes ? ` (${payment.admin_notes})` : '';
                                showToast(`Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯.${reason}`, 'error');
                            }
                        });
                    }

                    state.studentPayments = normalized;
                    state.studentPaymentsLoaded = true;
                    renderStudentPaymentHistory();
                    return normalized;
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error loading student payments:', error);
                    }
                    return state.studentPayments;
                }
            }

            function startStudentPaymentPolling() {
                if (CURRENT_USER.role !== 'student') {
                    return;
                }
                if (studentPaymentPollingInterval) {
                    return;
                }
                studentPaymentPollingInterval = setInterval(() => {
                    loadStudentPayments({ notify: true }).catch(error => {
                        console.error('Error while polling student payments:', error);
                    });
                }, STUDENT_PAYMENT_POLL_INTERVAL);
            }

            function stopStudentPaymentPolling() {
                if (studentPaymentPollingInterval) {
                    clearInterval(studentPaymentPollingInterval);
                    studentPaymentPollingInterval = null;
                }
            }

            async function loadConversations(force = false) {
                if (state.conversationsLoaded && !force) {
                    return state.conversations;
                }
                try {
                    const conversations = await fetchJSON('/api/chat/conversations/');
                    state.conversations = Array.isArray(conversations) ? conversations : [];
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error loading conversations:', error);
                    }
                    state.conversations = [];
                } finally {
                    state.conversationsLoaded = true;
                    updateNotificationIndicator();
                }
                return state.conversations;
            }

            async function fetchChatMessages(userId, force = false) {
                if (!force && state.chatMessages[userId]) {
                    return state.chatMessages[userId];
                }
                try {
                    const messages = await fetchJSON(`/api/chat/messages/${userId}/`);
                    const normalized = Array.isArray(messages) ? messages : [];
                    state.chatMessages[userId] = normalized;
                    return normalized;
                } catch (error) {
                    console.error('Error loading chat messages:', error);
                    return state.chatMessages[userId] || [];
                }
            }

            function updateNotificationIndicator() {
                if (!chatNotificationDot) {
                    return;
                }
                const totalUnread = (state.conversations || []).reduce((sum, convo) => sum + (convo.unread_count || 0), 0);
                if (totalUnread > 0) {
                    chatNotificationDot.classList.remove('hidden');
                } else {
                    chatNotificationDot.classList.add('hidden');
                }
            }

            function getConversationDisplayName(convo) {
                if (!convo) {
                    return 'Ú©Ø§Ø±Ø¨Ø±';
                }
                const nameParts = [];
                if (convo.profile) {
                    if (convo.profile.first_name) nameParts.push(convo.profile.first_name);
                    if (convo.profile.last_name) nameParts.push(convo.profile.last_name);
                }
                const displayName = nameParts.join(' ').trim();
                return displayName || convo.username || 'Ú©Ø§Ø±Ø¨Ø±';
            }

            function populateChatList() {
                if (!chatList) {
                    return;
                }
                chatList.innerHTML = '';
                if (!state.conversations.length) {
                    chatList.innerHTML = '<p class="text-sm text-gray-500 p-3">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                    updateNotificationIndicator();
                    return;
                }

                state.conversations.forEach(convo => {
                    const displayName = getConversationDisplayName(convo);
                    const lastMessage = convo.last_message || '';
                    const listItem = document.createElement('div');
                    listItem.className = 'p-3 flex items-center gap-3 hover:bg-gray-100 cursor-pointer border-b';
                    const avatarInitial = displayName.charAt(0) || '?';
                    listItem.innerHTML = `<img src="https://placehold.co/40x40/e0e7ff/4338ca?text=${avatarInitial}" class="w-10 h-10 rounded-full"><div><p class="font-bold">${displayName}</p><p class="text-sm text-gray-500 truncate">${lastMessage || 'Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ§Ù…'}</p></div>`;
                    listItem.addEventListener('click', () => {
                        renderMessages(convo.id, displayName).catch(error => {
                            console.error('Error rendering messages:', error);
                            chatMessagesContainer.innerHTML = '<p class="text-sm text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§.</p>';
                        });
                    });
                    chatList.appendChild(listItem);
                });

                updateNotificationIndicator();
            }

            function updateMessagesUI(userId) {
                if (!chatMessagesContainer) {
                    return;
                }
                const messages = state.chatMessages[userId] || [];
                chatMessagesContainer.innerHTML = '';
                if (!messages.length) {
                    chatMessagesContainer.innerHTML = '<p class="text-sm text-gray-500">Ù¾ÛŒØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                    return;
                }

                messages.forEach(msg => {
                    const isMe = msg.sender === CURRENT_USER.id;
                    const wrapper = document.createElement('div');
                    wrapper.className = `flex flex-col gap-1 ${isMe ? 'items-end' : 'items-start'}`;

                    const bubble = document.createElement('div');
                    bubble.className = `max-w-xs md:max-w-sm w-full rounded-2xl px-3 py-2 shadow ${isMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'}`;
                    bubble.classList.add('flex', 'flex-col', 'gap-2');

                    const hasText = !!(msg.text && msg.text.trim());
                    const hasFile = Boolean(msg.file);
                    const hasVoice = Boolean(msg.voice);

                    if (hasText) {
                        const textEl = document.createElement('div');
                        textEl.className = 'whitespace-pre-wrap leading-6 text-sm text-right break-words';
                        textEl.textContent = msg.text;
                        bubble.appendChild(textEl);
                    }

                    if (hasFile) {
                        const fileLink = document.createElement('a');
                        fileLink.href = msg.file;
                        fileLink.target = '_blank';
                        fileLink.rel = 'noopener noreferrer';
                        fileLink.className = `inline-flex items-center gap-2 text-sm font-medium ${isMe ? 'text-white underline-offset-4 hover:underline' : 'text-indigo-700 hover:text-indigo-900 underline-offset-4 hover:underline'}`;
                        fileLink.innerHTML = `<i class="fas fa-paperclip"></i><span>${extractFileName(msg.file)}</span>`;
                        bubble.appendChild(fileLink);
                    }

                    if (hasVoice) {
                        const audioContainer = document.createElement('div');
                        audioContainer.className = 'rounded-lg overflow-hidden bg-white';
                        const audioEl = document.createElement('audio');
                        audioEl.controls = true;
                        audioEl.preload = 'none';
                        audioEl.src = msg.voice;
                        audioEl.className = 'w-full';
                        audioContainer.appendChild(audioEl);
                        bubble.appendChild(audioContainer);
                    }

                    if (!hasText && !hasFile && !hasVoice) {
                        const placeholder = document.createElement('span');
                        placeholder.className = 'text-sm opacity-80';
                        placeholder.textContent = 'Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆØ§';
                        bubble.appendChild(placeholder);
                    }

                    wrapper.appendChild(bubble);

                    const timestamp = document.createElement('span');
                    timestamp.className = `text-[11px] ${isMe ? 'text-indigo-100' : 'text-gray-500'}`;
                    timestamp.textContent = formatChatTimestamp(msg.timestamp);
                    wrapper.appendChild(timestamp);

                    chatMessagesContainer.appendChild(wrapper);
                });
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }

            function haveMessagesChanged(previousMessages, nextMessages) {
                if (previousMessages.length !== nextMessages.length) {
                    return true;
                }
                if (!previousMessages.length) {
                    return false;
                }
                const prevLast = previousMessages[previousMessages.length - 1];
                const nextLast = nextMessages[nextMessages.length - 1];
                if (!prevLast && !nextLast) {
                    return false;
                }
                if (!prevLast || !nextLast) {
                    return true;
                }
                return prevLast.id !== nextLast.id
                    || prevLast.timestamp !== nextLast.timestamp
                    || prevLast.text !== nextLast.text
                    || prevLast.file !== nextLast.file
                    || prevLast.voice !== nextLast.voice
                    || prevLast.is_read !== nextLast.is_read;
            }

            function startMessagePolling(userId) {
                stopMessagePolling();
                if (!userId) {
                    return;
                }
                messagePollingInterval = setInterval(async () => {
                    try {
                        const previousMessages = state.chatMessages[userId] ? [...state.chatMessages[userId]] : [];
                        const latestMessages = await fetchChatMessages(userId, true);
                        if (haveMessagesChanged(previousMessages, latestMessages)) {
                            updateMessagesUI(userId);
                        }
                    } catch (error) {
                        console.error('Error polling messages:', error);
                    }
                }, CHAT_POLL_INTERVAL);
            }

            function stopMessagePolling() {
                if (messagePollingInterval) {
                    clearInterval(messagePollingInterval);
                    messagePollingInterval = null;
                }
            }

            function startConversationPolling() {
                if (conversationPollingInterval) {
                    return;
                }
                conversationPollingInterval = setInterval(async () => {
                    if (chatWindow.classList.contains('hidden')) {
                        stopConversationPolling();
                        return;
                    }
                    try {
                        await loadConversations(true);
                        if (!chatList.classList.contains('hidden')) {
                            populateChatList();
                        }
                    } catch (error) {
                        console.error('Error refreshing conversations:', error);
                    }
                }, CHAT_POLL_INTERVAL);
            }

            function stopConversationPolling() {
                if (conversationPollingInterval) {
                    clearInterval(conversationPollingInterval);
                    conversationPollingInterval = null;
                }
            }

            async function handleSendMessage() {
                if (!chatInput || !chatSendBtn) {
                    return;
                }
                if (!activeChatUserId) {
                    showToast('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }

                const text = chatInput.value.trim();
                const hasFile = !!chatSelectedFile;
                const hasVoice = !!chatVoiceBlob;

                if (!text && !hasFile && !hasVoice) {
                    showToast('Ù„Ø·ÙØ§ Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒØŒ ÙØ§ÛŒÙ„ ÛŒØ§ Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.', 'error');
                    chatInput.focus();
                    return;
                }

                const formData = new FormData();
                if (text) {
                    formData.append('text', text);
                }
                if (hasFile && chatSelectedFile) {
                    formData.append('file', chatSelectedFile);
                }
                if (hasVoice && chatVoiceBlob) {
                    const voiceType = chatVoiceBlob.type || 'audio/webm';
                    const voiceFileName = `voice-${Date.now()}.webm`;
                    if (typeof File !== 'undefined') {
                        const voiceFile = new File([chatVoiceBlob], voiceFileName, { type: voiceType });
                        formData.append('voice', voiceFile);
                    } else {
                        formData.append('voice', chatVoiceBlob, voiceFileName);
                    }
                }

                chatSendBtn.disabled = true;
                chatSendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                try {
                    const newMessage = await fetchJSON(`/api/chat/messages/${activeChatUserId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken },
                        body: formData,
                    });

                    if (!Array.isArray(state.chatMessages[activeChatUserId])) {
                        state.chatMessages[activeChatUserId] = [];
                    }
                    if (newMessage) {
                        state.chatMessages[activeChatUserId].push(newMessage);
                    }
                    updateMessagesUI(activeChatUserId);
                    if (chatInput) {
                        chatInput.value = '';
                        chatInput.focus();
                    }
                    clearFileAttachment();
                    removeVoiceAttachment({ notify: false });
                    await loadConversations(true);
                    if (!chatList.classList.contains('hidden')) {
                        populateChatList();
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    showToast(error.message || 'Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.', 'error');
                } finally {
                    chatSendBtn.disabled = false;
                    chatSendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            const hideEmojiPicker = () => {
                if (!emojiPickerElement) {
                    return;
                }
                emojiPickerElement.classList.add('hidden');
                emojiPickerElement.style.display = 'none';
                emojiPickerElement.style.visibility = 'hidden';
                emojiPickerVisible = false;
            };

            const positionEmojiPicker = () => {
                if (!emojiPickerElement || !chatEmojiBtn) {
                    return;
                }
                const buttonRect = chatEmojiBtn.getBoundingClientRect();
                emojiPickerElement.style.display = 'grid';
                emojiPickerElement.style.visibility = 'hidden';
                const pickerRect = emojiPickerElement.getBoundingClientRect();
                let left = buttonRect.left + (buttonRect.width / 2) - (pickerRect.width / 2);
                let top = buttonRect.top - pickerRect.height - 8;
                if (top < 8) {
                    top = buttonRect.bottom + 8;
                }
                if (left < 8) {
                    left = 8;
                }
                const maxLeft = window.innerWidth - pickerRect.width - 8;
                if (left > maxLeft) {
                    left = maxLeft;
                }
                emojiPickerElement.style.left = `${left}px`;
                emojiPickerElement.style.top = `${top}px`;
                emojiPickerElement.style.visibility = 'visible';
            };

            const showEmojiPicker = () => {
                if (!chatEmojiBtn || !chatInput) {
                    return;
                }
                if (!emojiPickerElement) {
                    emojiPickerElement = document.createElement('div');
                    emojiPickerElement.id = 'chat-emoji-picker';
                    emojiPickerElement.className = 'hidden fixed bg-white border border-gray-200 rounded-xl shadow-2xl p-2 grid grid-cols-8 gap-1 text-xl z-[1000]';
                    emojiPickerElement.setAttribute('dir', 'ltr');

                    EMOJI_PICKER_EMOJIS.forEach((emoji) => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'w-9 h-9 flex items-center justify-center rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-500';
                        button.textContent = emoji;
                        button.addEventListener('click', (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            const start = chatInput.selectionStart ?? chatInput.value.length;
                            const end = chatInput.selectionEnd ?? chatInput.value.length;
                            const currentValue = chatInput.value;
                            chatInput.value = `${currentValue.slice(0, start)}${emoji}${currentValue.slice(end)}`;
                            const cursorPosition = start + emoji.length;
                            chatInput.focus();
                            chatInput.setSelectionRange(cursorPosition, cursorPosition);
                            hideEmojiPicker();
                        });
                        emojiPickerElement.appendChild(button);
                    });

                    document.body.appendChild(emojiPickerElement);
                }

                emojiPickerElement.classList.remove('hidden');
                emojiPickerElement.style.display = 'grid';
                emojiPickerElement.style.visibility = 'hidden';
                positionEmojiPicker();
                emojiPickerVisible = true;
            };

            function initializeEmojiPicker() {
                if (!chatEmojiBtn || !chatInput) {
                    return;
                }
                if (chatEmojiBtn.dataset.emojiPickerInitialized === 'true') {
                    return;
                }
                chatEmojiBtn.dataset.emojiPickerInitialized = 'true';

                chatEmojiBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (emojiPickerVisible) {
                        hideEmojiPicker();
                    } else {
                        showEmojiPicker();
                    }
                });

                document.addEventListener('click', (event) => {
                    if (!emojiPickerVisible) {
                        return;
                    }
                    if (emojiPickerElement && (emojiPickerElement === event.target || emojiPickerElement.contains(event.target))) {
                        return;
                    }
                    if (event.target === chatEmojiBtn) {
                        return;
                    }
                    hideEmojiPicker();
                });

                window.addEventListener('resize', () => {
                    if (emojiPickerVisible) {
                        positionEmojiPicker();
                    }
                });

                if (chatWindow) {
                    chatWindow.addEventListener('scroll', () => {
                        if (emojiPickerVisible) {
                            positionEmojiPicker();
                        }
                    });
                }
            }

            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modalBackdrop.classList.remove('hidden');
                    modal.classList.remove('hidden');
                }
            };

            const closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    const content = modal.querySelector('.modal-enter');
                    if (content) content.classList.replace('modal-enter', 'modal-leave');
                    setTimeout(() => {
                        modalBackdrop.classList.add('hidden');
                        modal.classList.add('hidden');
                        if (content) content.classList.replace('modal-leave', 'modal-enter');
                    }, 300);
                }
                if (modalId === 'course-details-modal') {
                    activeCourseId = null;
                }
            };

            function openCourseDetailsModal(course) {
                if (!course) {
                    return;
                }
                activeCourseId = course.id;
                renderCourseDetails(course);
                openModal('course-details-modal');
                refreshCourse(course.id, { reRenderModal: true, suppressErrorToast: true }).catch(error => {
                    console.error('Error refreshing course details:', error);
                });
            }

            const createCourseCard = (course) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm mb-3 course-card cursor-pointer';
                const totalSessions = course.sessions.length || 4;
                const completedSessions = course.sessions.filter(s => s.completed).length;
                const progressPercentage = totalSessions ? (completedSessions / totalSessions) * 100 : 0;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${course.studentName}</p>
                            <p class="text-sm text-indigo-600 font-semibold">${course.time || 'â€”'}</p>
                        </div>
                        <div class="text-gray-400 text-lg hover:text-indigo-600">
                            <i class="fa-solid fa-square-arrow-up-right"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-gray-500 mb-1">Ù¾ÛŒØ´Ø±ÙØª Ø¯ÙˆØ±Ù‡ (${completedSessions} Ø§Ø² ${totalSessions})</p>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openCourseDetailsModal(course));
                return card;
            };

            const renderCalendar = () => {
                if (!calendarGrid) return;
                calendarGrid.innerHTML = '';
                let filteredCourses = [...state.courses];

                if (currentRole === 'counselor' && CURRENT_USER.advisorId) {
                    filteredCourses = filteredCourses.filter(course => course.advisorId === CURRENT_USER.advisorId);
                } else if (currentRole === 'student' && CURRENT_USER.studentId) {
                    filteredCourses = filteredCourses.filter(course => course.studentId === CURRENT_USER.studentId);
                } else if (currentRole === 'admin' && CURRENT_USER.isStaff && counselorFilter) {
                    const selectedAdvisorId = counselorFilter.value || 'all';
                    if (selectedAdvisorId !== 'all') {
                        filteredCourses = filteredCourses.filter(course => String(course.advisorId) === selectedAdvisorId);
                    }
                }

                daysOfWeek.forEach(day => {
                    const column = document.createElement('div');
                    column.className = 'day-column p-2';
                    column.innerHTML = `<h3 class="font-extrabold text-center p-2 text-gray-700">${day}</h3>`;
                    const dayCourses = filteredCourses.filter(course => course.dayOfWeek === day);
                    if (!dayCourses.length) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.className = 'text-sm text-gray-400 text-center py-4';
                        emptyMessage.textContent = 'Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
                        column.appendChild(emptyMessage);
                    } else {
                        dayCourses.forEach(course => column.appendChild(createCourseCard(course)));
                    }
                    calendarGrid.appendChild(column);
                });
            };

            const switchRole = (role, buttonElement) => {
                if (role === 'admin' && !CURRENT_USER.isStaff) {
                    alert('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯.');
                    return;
                }
                currentRole = role;
                document.querySelectorAll('.view-switcher-active').forEach(btn => btn.classList.remove('view-switcher-active'));
                if (buttonElement) {
                    buttonElement.classList.add('view-switcher-active');
                }
                updateRoleIndicator();
                const showAdminControls = role === 'admin' && CURRENT_USER.isStaff;
                adminControls.classList.toggle('hidden', !showAdminControls);
                adminControls.classList.toggle('flex', showAdminControls);
                studentControls.classList.toggle('hidden', role !== 'student');
                studentControls.classList.toggle('flex', role === 'student');
                setCounselorFilterDisabled(!showAdminControls);
                if (role === 'student') {
                    loadStudentPayments({ notify: false }).catch(error => {
                        console.error('Error loading student payments:', error);
                    });
                    startStudentPaymentPolling();
                } else {
                    stopStudentPaymentPolling();
                }
                chatWindow.classList.add('hidden');
                chatMessagesView.classList.add('hidden');
                chatMessagesView.style.display = 'none';
                chatList.classList.remove('hidden');
                stopConversationPolling();
                stopMessagePolling();
                activeChatUserId = null;
                activeChatDisplayName = '';
                renderCalendar();
            };

            async function renderMessages(userId, otherPartyName, options = {}) {
                const { force = false } = options;
                activeChatUserId = userId;
                if (typeof otherPartyName === 'string' && otherPartyName.trim()) {
                    activeChatDisplayName = otherPartyName;
                }

                resetChatComposer({ clearText: true });
                chatList.classList.add('hidden');
                chatMessagesView.style.display = 'flex';
                chatMessagesView.classList.remove('hidden');
                backToChatsBtn.classList.remove('hidden');
                chatTitle.textContent = activeChatDisplayName || 'Ú†Øª';
                chatMessagesContainer.innerHTML = '';

                await fetchChatMessages(userId, force);
                updateMessagesUI(userId);
                chatInput?.focus();

                await loadConversations(true);
                startMessagePolling(userId);
            }

            async function renderChatList(force = false) {
                resetChatComposer({ clearText: true });
                chatMessagesContainer.innerHTML = '';
                chatMessagesView.classList.add('hidden');
                chatMessagesView.style.display = 'none';
                chatList.classList.remove('hidden');
                backToChatsBtn.classList.add('hidden');
                chatTitle.textContent = 'Ú†Øªâ€ŒÙ‡Ø§';
                activeChatUserId = null;
                activeChatDisplayName = '';
                stopMessagePolling();

                if (force) {
                    await loadConversations(true);
                } else if (!state.conversationsLoaded) {
                    await loadConversations();
                }

                populateChatList();
            }

            async function getAdminData(force = false) {
                if (!CURRENT_USER.isStaff) {
                    return null;
                }
                if (state.adminData && !force) {
                    return state.adminData;
                }
                try {
                    const data = await fetchJSON('/api/admin-panel-data/');
                    state.adminData = data;
                    return data;
                } catch (error) {
                    if (error.status !== 403) {
                        console.error('Error fetching admin data:', error);
                    }
                    state.adminData = null;
                    return null;
                }
            }

            const renderAdminView = async (viewName) => {
                if (!CURRENT_USER.isStaff) {
                    adminPanelContent.innerHTML = '<p class="text-sm text-gray-600">Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.</p>';
                    return;
                }

                document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => item.classList.remove('active'));
                const activeButton = document.querySelector(`#admin-menu .admin-menu-item[data-view="${viewName}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }

                adminPanelContent.innerHTML = '<div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;"></div>';

                let data = null;
                if (['add-student', 'assign-student'].includes(viewName)) {
                    data = await getAdminData();
                    if (!data) {
                        adminPanelContent.innerHTML = '<p class="text-red-500">Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                        return;
                    }
                }

                let content = '';
                switch (viewName) {
                    case 'add-student': {
                        const gradeOptions = data.grades.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                        const majorOptions = data.majors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                        content = `
                            <h3 class="text-xl font-bold mb-4">ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯</h3>
                            <form id="add-student-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700">Ù†Ø§Ù…</label><input name="first_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label><input name="last_name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label><input name="phone_number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label><select name="grade_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${gradeOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ø±Ø´ØªÙ‡</label><select name="major_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${majorOptions}</select></div>
                                <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Ø§ÙØ²ÙˆØ¯Ù†</button></div>
                            </form>`;
                        break;
                    }
                    case 'assign-student': {
                        const studentOptions = data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                        const advisorOptions = data.advisors.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                        const dayOptions = daysOfWeek.map(d => `<option value="${d}">${d}</option>`).join('');
                        content = `
                            <h3 class="text-xl font-bold mb-4">ØªØ®ØµÛŒØµ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±</h3>
                            <form id="assign-student-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label><select name="student_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${studentOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´Ø§ÙˆØ±</label><select name="advisor_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${advisorOptions}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Ø±ÙˆØ² Ø¬Ù„Ø³Ù‡</label><select name="day_of_week" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${dayOptions}</select></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÛŒØ® Ø§ÙˆÙ„ÛŒÙ† Ø¬Ù„Ø³Ù‡</label>
                                    <div class="mt-1 relative">
                                        <input id="assign-start-date-display" type="text" required autocomplete="off" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® (Ù…Ø«Ø§Ù„: Û±Û´Û°Û²/Û°Û±/Û±Ûµ)" class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="far fa-calendar-alt"></i></span>
                                        <input id="assign-start-date-hidden" type="hidden" name="start_date">
                                    </div>
                                </div>
                                <div><label class="block text-sm font-medium text-gray-700">Ø³Ø§Ø¹Øª Ø¬Ù„Ø³Ù‡</label><input name="start_time" type="time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                                <div class="text-left"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ØªØ®ØµÛŒØµ</button></div>
                            </form>`;
                        break;
                    }
                    case 'financials': {
                        await loadPayments();
                        if (!state.payments.length) {
                            content = '<p class="text-sm text-gray-600">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                        } else {
                            const statusLabels = {
                                pending: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
                                approved: 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                                rejected: 'Ø±Ø¯ Ø´Ø¯Ù‡',
                            };
                            const statusClassMap = {
                                pending: 'text-amber-500',
                                approved: 'text-green-600',
                                rejected: 'text-red-500',
                            };
                            const rows = state.payments.map(payment => {
                                const actionButtons = payment.status === 'pending'
                                    ? `
                                        <div class="flex flex-wrap gap-2">
                                            <button data-payment-action="approve" data-payment-id="${payment.id}" class="approve-payment-btn px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded-md transition">ØªØ§ÛŒÛŒØ¯</button>
                                            <button data-payment-action="reject" data-payment-id="${payment.id}" class="reject-payment-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md transition">Ø±Ø¯</button>
                                        </div>
                                    `
                                    : '<span class="text-xs text-gray-400">---</span>';
                                return `
                                <tr class="border-b">
                                    <td class="px-3 py-2 text-sm text-gray-700">${payment.student_name || '---'}</td>
                                    <td class="px-3 py-2 text-sm text-gray-700">${Number(payment.amount).toLocaleString('fa-IR')}</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${payment.reference_number}</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${formatToJalali(payment.payment_date)}</td>
                                    <td class="px-3 py-2 text-sm font-semibold ${statusClassMap[payment.status] || 'text-gray-600'}">${payment.status_display || statusLabels[payment.status] || payment.status}</td>
                                    <td class="px-3 py-2">${actionButtons}</td>
                                </tr>
                            `;
                            }).join('');
                            content = `
                                <h3 class="text-xl font-bold mb-4">Ú¯Ø²Ø§Ø±Ø´ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h3>
                                <div class="overflow-x-auto">
                                    <table id="admin-payments-table" class="min-w-full bg-white rounded-lg shadow-sm">
                                        <thead class="bg-gray-100 text-gray-700 text-sm">
                                            <tr>
                                                <th class="px-3 py-2 text-right font-semibold">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                                                <th class="px-3 py-2 text-right font-semibold">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th>
                                                <th class="px-3 py-2 text-right font-semibold">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</th>
                                                <th class="px-3 py-2 text-right font-semibold">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                                                <th class="px-3 py-2 text-right font-semibold">ÙˆØ¶Ø¹ÛŒØª</th>
                                                <th class="px-3 py-2 text-right font-semibold">Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rows}</tbody>
                                    </table>
                                </div>`;
                        }
                        break;
                    }
                    case 'send-notification': {
                        if (!CURRENT_USER.isStaff) {
                            content = '<p class="text-sm text-gray-600">Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§ÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</p>';
                            break;
                        }

                        let loadError = null;
                        try {
                            await loadNotificationRecipients({ force: !state.notificationRecipientsLoaded });
                        } catch (error) {
                            loadError = error.message || state.notificationRecipientsError;
                        }

                        if (loadError) {
                            content = `<p class="text-sm text-red-500">${escapeHtml(loadError)}</p>`;
                            break;
                        }

                        const recipients = Array.isArray(state.notificationRecipients)
                            ? state.notificationRecipients
                            : [];

                        if (!recipients.length) {
                            content = '<p class="text-sm text-gray-600">Ù‡ÛŒÚ† Ù…Ø®Ø§Ø·Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                            break;
                        }

                        const recipientOptions = buildNotificationRecipientOptions(recipients);

                        content = `
                            <div class="space-y-6">
                                <h3 class="text-xl font-bold">Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† Ø¬Ø¯ÛŒØ¯</h3>
                                <form id="send-notification-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø®Ø§Ø·Ø¨Ø§Ù†</label>
                                        <select id="notification-recipient-select" class="w-full border border-gray-300 rounded-md shadow-sm" multiple>
                                            ${recipientOptions}
                                        </select>
                                        <p class="mt-2 text-xs text-gray-500">Ø¨Ø§ ØªØ§ÛŒÙ¾ Ù†Ø§Ù… ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø®Ø§Ø·Ø¨ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¨ÛŒØ§Ø¨ÛŒØ¯.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…ØªÙ† Ø§Ø¹Ù„Ø§Ù†</label>
                                        <textarea id="notification-message" rows="4" class="w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                                    </div>
                                    <div>
                                        <span class="block text-sm font-medium text-gray-700 mb-1">Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„</span>
                                        <div class="flex flex-wrap gap-4 text-sm">
                                            <label class="inline-flex items-center gap-2">
                                                <input type="checkbox" name="channels" value="panel" class="rounded text-indigo-600" checked>
                                                <span>Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾Ù†Ù„</span>
                                            </label>
                                            <label class="inline-flex items-center gap-2">
                                                <input type="checkbox" name="channels" value="telegram" class="rounded text-indigo-600">
                                                <span>ØªÙ„Ú¯Ø±Ø§Ù…</span>
                                            </label>
                                            <label class="inline-flex items-center gap-2">
                                                <input type="checkbox" name="channels" value="sms" class="rounded text-indigo-600">
                                                <span>Ù¾ÛŒØ§Ù…Ú©</span>
                                            </label>
                                        </div>
                                        <p class="mt-2 text-xs text-gray-500">Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù… ÛŒØ§ Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.</p>
                                    </div>
                                    <div id="notification-form-feedback" class="hidden text-sm"></div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù†</button>
                                    </div>
                                </form>
                            </div>
                        `;
                        break;
                    }
                    case 'reports': {
                        await loadAdvisors();
                        const filters = ensureReportFilters();
                        const advisorList = Array.isArray(state.advisors) ? state.advisors.slice() : [];
                        const advisorValue = filters.advisorId && filters.advisorId !== 'all'
                            ? String(filters.advisorId)
                            : 'all';
                        const startLabel = filters.startDate ? formatToJalaliShort(filters.startDate) : '';
                        const endLabel = filters.endDate ? formatToJalaliShort(filters.endDate) : '';
                        const advisorOptions = [];
                        advisorOptions.push(`<option value="all"${advisorValue === 'all' ? ' selected' : ''}>Ù‡Ù…Ù‡ Ù…Ø´Ø§ÙˆØ±Ø§Ù†</option>`);
                        advisorList
                            .sort((a, b) => (a.full_name || '').localeCompare(b.full_name || '', 'fa'))
                            .forEach(advisor => {
                                if (!advisor || typeof advisor.id === 'undefined') {
                                    return;
                                }
                                const value = String(advisor.id);
                                const selected = advisorValue === value ? ' selected' : '';
                                const label = advisor.full_name || `Ù…Ø´Ø§ÙˆØ± ${advisor.id}`;
                                advisorOptions.push(`<option value="${value}"${selected}>${escapeHtml(label)}</option>`);
                            });

                        content = `
                            <div class="space-y-6">
                                <h3 class="text-xl font-bold">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h3>
                                <form id="reports-filter-form" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
                                        <input id="report-start-display" type="text" class="w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹" autocomplete="off" value="${filters.startDate ? escapeHtml(startLabel) : ''}">
                                        <input id="report-start-hidden" type="hidden" value="${filters.startDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                                        <input id="report-end-display" type="text" class="w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†" autocomplete="off" value="${filters.endDate ? escapeHtml(endLabel) : ''}">
                                        <input id="report-end-hidden" type="hidden" value="${filters.endDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ø´Ø§ÙˆØ±</label>
                                        <select id="report-advisor-select" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                                            ${advisorOptions.join('')}
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <button id="reports-refresh-btn" type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
                                    </div>
                                </form>
                                <div id="reports-results" class="space-y-6">
                                    <p class="text-sm text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§...</p>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    default:
                        content = '<p class="text-sm text-gray-600">ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ø² Ù…Ù†Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
                }

                adminPanelContent.innerHTML = content;

                if (viewName === 'reports') {
                    setupReportsView().catch(error => {
                        console.error('Error initializing reports view:', error);
                        renderReportsError(error?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§.');
                    });
                }

                if (viewName === 'send-notification') {
                    const notificationForm = document.getElementById('send-notification-form');
                    const recipientSelect = document.getElementById('notification-recipient-select');
                    if (recipientSelect) {
                        initializeNotificationRecipientSelect(recipientSelect);
                    }
                    if (notificationForm) {
                        notificationForm.addEventListener('submit', handleSendNotificationSubmit);
                    }
                }

                const addStudentForm = document.getElementById('add-student-form');
                if (addStudentForm) {
                    addStudentForm.addEventListener('submit', handleAddStudent);
                }
                const assignStudentForm = document.getElementById('assign-student-form');
                const assignStartDisplay = document.getElementById('assign-start-date-display');
                const assignStartHidden = document.getElementById('assign-start-date-hidden');
                if (assignStartDisplay && assignStartHidden) {
                    setupJalaliDatePicker(assignStartDisplay, assignStartHidden);
                }
                if (assignStudentForm) {
                    assignStudentForm.addEventListener('submit', handleAssignStudent);
                }
                const adminPaymentsTable = document.getElementById('admin-payments-table');
                if (adminPaymentsTable) {
                    adminPaymentsTable.addEventListener('click', handleAdminPaymentAction);
                }
            };

            async function handleAdminPaymentAction(event) {
                const actionButton = event.target.closest('[data-payment-action]');
                if (!actionButton) {
                    return;
                }
                event.preventDefault();

                const paymentId = actionButton.dataset.paymentId;
                const action = actionButton.dataset.paymentAction;
                if (!paymentId || !action) {
                    return;
                }

                let requestBody = null;
                if (action === 'reject') {
                    const reason = prompt('Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):');
                    if (reason === null) {
                        return;
                    }
                    if (reason.trim()) {
                        requestBody = { notes: reason.trim() };
                    }
                }

                const originalContent = actionButton.innerHTML;
                actionButton.disabled = true;
                actionButton.classList.add('opacity-70', 'cursor-not-allowed');
                actionButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    await updatePaymentStatus(paymentId, action, requestBody);
                    const message = action === 'approve' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.' : 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø¯ Ø´Ø¯.';
                    showToast(message, action === 'approve' ? 'success' : 'info');
                    await renderAdminView('financials');
                } catch (error) {
                    actionButton.disabled = false;
                    actionButton.classList.remove('opacity-70', 'cursor-not-allowed');
                    actionButton.innerHTML = originalContent;
                    const message = error.message || 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
                    showToast(message, 'error');
                }
            }

            async function handleAddStudent(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/add-student/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (response.status === 201) {
                        alert(result.message);
                        state.adminData = null;
                        await renderAdminView('assign-student');
                    } else {
                        alert(`Ø®Ø·Ø§: ${result.message || 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'}`);
                    }
                } catch (error) {
                    alert('ÛŒÚ© Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø±Ø® Ø¯Ø§Ø¯.');
                }
            }

            async function handleAssignStudent(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                data.day_of_week = FA_TO_EN_DAYS[data.day_of_week] || data.day_of_week;

                try {
                    const response = await fetch('/api/assign-student/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (response.status === 201) {
                        alert(result.message);
                        state.adminData = null;
                        await loadCourses();
                        updateCounselorFilterOptions();
                        renderCalendar();
                        await renderAdminView('assign-student');
                    } else {
                        alert(`Ø®Ø·Ø§: ${result.message || 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'}`);
                    }
                } catch (error) {
                    alert('ÛŒÚ© Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø±Ø® Ø¯Ø§Ø¯.');
                }
            }

            const roleButtonMap = {
                admin: adminBtn,
                counselor: counselorBtn,
                student: studentBtn,
            };

            function updateRoleIndicator() {
                if (!roleIndicator) return;
                const label = ROLE_LABELS[currentRole];
                if (label) {
                    roleIndicator.textContent = label;
                    roleIndicator.classList.remove('hidden');
                } else {
                    roleIndicator.textContent = '';
                    roleIndicator.classList.add('hidden');
                }
            }

            if (adminBtn) {
                adminBtn.addEventListener('click', (e) => {
                    if (!CURRENT_USER.isStaff) {
                        alert('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯.');
                        return;
                    }
                    switchRole('admin', e.currentTarget);
                });
            }
            if (counselorBtn) {
                counselorBtn.addEventListener('click', (e) => switchRole('counselor', e.currentTarget));
            }
            if (studentBtn) {
                studentBtn.addEventListener('click', (e) => switchRole('student', e.currentTarget));
            }

            if (counselorFilter) {
                counselorFilter.addEventListener('change', () => renderCalendar());
            }

            document.querySelectorAll('#admin-menu .admin-menu-item').forEach(item => {
                item.addEventListener('click', () => renderAdminView(item.dataset.view));
            });

            const openAdminPanelBtn = document.getElementById('open-admin-panel-btn');
            if (openAdminPanelBtn) {
                openAdminPanelBtn.addEventListener('click', () => {
                    renderAdminView('add-student');
                    openModal('admin-panel-modal');
                });
            }

            const openPaymentModalBtn = document.getElementById('open-payment-modal-btn');
            if (openPaymentModalBtn) {
                openPaymentModalBtn.addEventListener('click', () => {
                    openModal('payment-modal');
                    if (paymentForm) {
                        paymentForm.reset();
                    }
                    if (paymentDateDisplayInput && paymentDateHiddenInput) {
                        paymentDateDisplayInput.value = '';
                        paymentDateHiddenInput.value = '';
                    }
                    initializePaymentDatePicker();
                    loadStudentPayments({ notify: false }).catch(error => {
                        console.error('Error refreshing payment history:', error);
                    });
                });
            }

            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    openNotificationsModal().catch(error => {
                        console.error('Error opening notifications modal:', error);
                    });
                });
            }

            if (notificationsRefreshBtn) {
                notificationsRefreshBtn.addEventListener('click', async (event) => {
                    event.preventDefault();
                    try {
                        await loadNotifications({ force: true });
                    } catch (error) {
                        console.error('Error refreshing notifications:', error);
                    }
                });
            }

            if (paymentDateDisplayInput) {
                paymentDateDisplayInput.addEventListener('change', () => updateHiddenPaymentDateFromDisplay({ silent: true }));
                paymentDateDisplayInput.addEventListener('blur', () => updateHiddenPaymentDateFromDisplay({ silent: true }));
            }

            initializePaymentDatePicker();

            if (paymentForm) {
                paymentForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    if (paymentSubmitBtn) {
                        paymentSubmitBtn.disabled = true;
                    }
                    if (paymentFeedback) {
                        paymentFeedback.textContent = '';
                        paymentFeedback.classList.add('hidden');
                        paymentFeedback.classList.remove('text-green-600', 'text-red-600');
                    }

                    if (useJalaliDatePicker && paymentDateDisplayInput && paymentDateHiddenInput) {
                        updateHiddenPaymentDateFromDisplay({ silent: true });
                        if (!paymentDateHiddenInput.value) {
                            if (paymentSubmitBtn) {
                                paymentSubmitBtn.disabled = false;
                            }
                            showToast('Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                            return;
                        }
                    }

                    const formData = new FormData(paymentForm);
                    const payload = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetchJSON('/api/payments/submit/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken,
                            },
                            body: JSON.stringify(payload),
                        });
                        const successMessage = (response && response.message) || 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.';
                        showToast(successMessage, 'success');
                        if (paymentFeedback) {
                            paymentFeedback.textContent = successMessage;
                            paymentFeedback.classList.remove('hidden', 'text-red-600');
                            paymentFeedback.classList.add('text-green-600');
                        }
                        paymentForm.reset();
                        await loadStudentPayments({ notify: false });
                    } catch (error) {
                        const message = error.message || 'Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
                        showToast(message, 'error');
                        if (paymentFeedback) {
                            paymentFeedback.textContent = message;
                            paymentFeedback.classList.remove('hidden', 'text-green-600');
                            paymentFeedback.classList.add('text-red-600');
                        }
                    } finally {
                        if (paymentSubmitBtn) {
                            paymentSubmitBtn.disabled = false;
                        }
                    }
                });
            }

            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            if (chatToggleBtn) {
                chatToggleBtn.addEventListener('click', () => {
                    chatWindow.classList.toggle('hidden');
                    const isHidden = chatWindow.classList.contains('hidden');
                    if (!isHidden) {
                        renderChatList().catch(error => {
                            console.error('Error rendering chat list:', error);
                            chatList.innerHTML = '<p class="text-sm text-red-500 p-3">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Øª.</p>';
                        });
                        startConversationPolling();
                    } else {
                        stopConversationPolling();
                        stopMessagePolling();
                        resetChatComposer({ clearText: true });
                        hideEmojiPicker();
                        activeChatUserId = null;
                        activeChatDisplayName = '';
                        chatMessagesView.classList.add('hidden');
                        chatMessagesView.style.display = 'none';
                        chatList.classList.remove('hidden');
                        chatTitle.textContent = 'Ú†Øªâ€ŒÙ‡Ø§';
                    }
                });
            }

            backToChatsBtn.addEventListener('click', () => {
                renderChatList(true).catch(error => {
                    console.error('Error rendering chat list:', error);
                    chatList.innerHTML = '<p class="text-sm text-red-500 p-3">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Øª.</p>';
                });
            });

            if (chatFileBtn && chatFileInput) {
                chatFileBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    chatFileInput.click();
                });

                chatFileInput.addEventListener('change', (event) => {
                    const fileList = event.target.files;
                    if (fileList && fileList.length) {
                        chatSelectedFile = fileList[0];
                        updateAttachmentPreview();
                    } else {
                        clearFileAttachment();
                    }
                });
            }

            if (chatAttachmentPreview) {
                chatAttachmentPreview.addEventListener('click', (event) => {
                    const actionBtn = event.target.closest('button[data-action]');
                    if (!actionBtn) {
                        return;
                    }
                    const { action } = actionBtn.dataset;
                    if (action === 'remove-file') {
                        clearFileAttachment({ notify: true });
                    } else if (action === 'remove-voice') {
                        removeVoiceAttachment({ notify: true });
                    }
                });
            }

            if (chatVoiceBtn) {
                chatVoiceBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    handleVoiceButtonClick();
                });
            }

            initializeEmojiPicker();

            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', () => {
                    handleSendMessage().catch(error => {
                        console.error('Error sending message:', error);
                    });
                });
            }

            if (chatInput) {
                chatInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        handleSendMessage().catch(error => {
                            console.error('Error sending message:', error);
                        });
                    }
                });
            }

            const profileMenuBtn = document.getElementById('profile-menu-btn');
            if (profileMenuBtn && profileDropdown) {
                profileMenuBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.body.addEventListener('click', () => profileDropdown.classList.add('hidden'));
            }

            const openProfileModalBtn = document.getElementById('open-profile-modal-btn');
            if (openProfileModalBtn) {
                openProfileModalBtn.addEventListener('click', async (event) => {
                    event.preventDefault();
                    try {
                        await loadCurrentUserProfile();
                    } catch (error) {
                        console.error('Error loading profile before opening modal:', error);
                        showToast('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.', 'error');
                    }
                    if (uploadInput) {
                        uploadInput.value = '';
                    }
                    updateProfileImages();
                    openModal('profile-modal');
                });
            }

            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (!uploadInput || !uploadInput.files || !uploadInput.files[0]) {
                        showToast('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªØµÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
                        return;
                    }

                    const file = uploadInput.files[0];
                    const formData = new FormData();
                    formData.append('profile_picture', file);

                    const originalText = saveProfileBtn.textContent;
                    saveProfileBtn.disabled = true;
                    saveProfileBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

                    try {
                        const response = await fetch('/api/profile/', {
                            method: 'PATCH',
                            body: formData,
                            headers: {
                                'X-CSRFToken': csrftoken,
                            },
                            credentials: 'same-origin',
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            let message = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„.';
                            if (errorText) {
                                try {
                                    const errorData = JSON.parse(errorText);
                                    message = errorData.detail || errorData.message || message;
                                } catch (parseError) {
                                    // Ù…ØªÙ† ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                                }
                            }
                            throw new Error(message);
                        }

                        let data = null;
                        try {
                            data = await response.json();
                        } catch (parseError) {
                            data = null;
                        }
                        setProfileData(data || null, { cacheBust: true, loaded: true });
                        if (uploadInput) {
                            uploadInput.value = '';
                        }
                        closeModal('profile-modal');
                        showToast('Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                    } catch (error) {
                        console.error('Error updating profile picture:', error);
                        showToast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
                    } finally {
                        saveProfileBtn.disabled = false;
                        saveProfileBtn.textContent = originalText;
                    }
                });
            }

            if (uploadInput) {
                uploadInput.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            if (modalImg) {
                                modalImg.src = e.target.result;
                            }
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }

            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                        if (!modal.classList.contains('hidden')) {
                            closeModal(modal.id);
                        }
                    });
                }
            });

            document.body.addEventListener('click', e => {
                const closeButton = e.target.closest('[data-close-modal]');
                if (closeButton) {
                    closeModal(closeButton.dataset.closeModal);
                }
            });

            const initializeDashboard = async () => {
                await loadCurrentUserProfile();
                await loadCourses();
                await loadAdvisors();
                updateCounselorFilterOptions();
                renderCalendar();
                if (CURRENT_USER.isStaff) {
                    loadPayments();
                }
                try {
                    await loadNotifications({ force: true });
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
                startNotificationPolling();
                switchRole(currentRole, roleButtonMap[currentRole]);
            };

            initializeDashboard();
            updateNotificationIndicator();
            updateNotificationsBadge();
            window.addEventListener('beforeunload', () => {
                stopNotificationPolling();
            });
        });
    </script>
</body>
</html>
